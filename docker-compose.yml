version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hoa_backend_api
    user: "${UID:-1000}:${GID:-1000}"
    ports:
      - "${APP_PORT:-3001}:${PORT:-3001}"
    volumes:
      - ./backend/database:/usr/src/app/backend/database
      - ./backend/uploads:/usr/src/app/backend/uploads
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - DB_PATH=/usr/src/app/backend/database/test.db
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - hoa-app-network

  frontend:
    build:
      context: ./frontend # Build context is the frontend directory
      dockerfile: Dockerfile # Frontend-specific Dockerfile
    container_name: hoa_frontend_web
    ports:
      # Map host port 3000 to container's port 80 (nginx)
      - "${FRONTEND_PORT:-3000}:80"
    environment:
      # API URL for the frontend to connect to backend
      - VITE_API_BASE_URL=http://localhost:${APP_PORT:-3001}/api
    depends_on:
      - backend # Ensure backend starts before frontend
    restart: unless-stopped
    networks:
      - hoa-app-network

  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: hoa_test_runner
    user: "${UID:-1000}:${GID:-1000}"
    depends_on:
      - backend
    volumes:
      - ./backend:/usr/src/app/backend
      - /usr/src/app/backend/node_modules
    environment:
      - NODE_ENV=test
      - DB_PATH=/usr/src/app/backend/database/test.db
    env_file:
      - .env.test
    command: npm run test:debugging
    networks:
      - hoa-app-network

networks:
  hoa-app-network:
    driver: bridge

# Optional: Define named volumes if you prefer them over host mounts
# volumes:
#   hoa_db_data:
#   hoa_uploads_data: