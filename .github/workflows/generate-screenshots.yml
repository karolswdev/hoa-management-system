name: Generate User Guide Screenshots

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches:
      - 'claude/**'  # Run on Claude branches to generate screenshots for PRs
    paths:
      - 'frontend/src/**'
      - 'frontend/e2e/generate-screenshots.spec.ts'

jobs:
  generate-screenshots:
    name: Generate Screenshots
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Setup test database
        working-directory: backend
        run: |
          NODE_ENV=test npx sequelize-cli db:migrate
          # Seed test users for screenshots
          node -e "
          const bcrypt = require('bcryptjs');
          const sqlite3 = require('sqlite3').verbose();
          const db = new sqlite3.Database('database_test.sqlite');

          const adminPassword = bcrypt.hashSync('Admin123!@#', 10);
          const memberPassword = bcrypt.hashSync('Member123!@#', 10);

          db.serialize(() => {
            // Insert admin user
            db.run(\`INSERT OR REPLACE INTO Users (id, name, email, password, role, status, isVerified, createdAt, updatedAt)
                     VALUES (1, 'Admin User', 'admin@example.com', ?, 'admin', 'approved', 1, datetime('now'), datetime('now'))\`,
                   [adminPassword]);

            // Insert member user
            db.run(\`INSERT OR REPLACE INTO Users (id, name, email, password, role, status, isVerified, createdAt, updatedAt)
                     VALUES (2, 'Member User', 'member@example.com', ?, 'member', 'approved', 1, datetime('now'), datetime('now'))\`,
                   [memberPassword]);

            // Insert sample announcements
            db.run(\`INSERT OR REPLACE INTO Announcements (id, title, content, expiresAt, createdBy, createdAt, updatedAt)
                     VALUES (1, 'Welcome to Sanderson Creek HOA', 'We are excited to have you as part of our community. This portal allows you to stay connected with HOA announcements, events, and important documents.', datetime('now', '+30 days'), 1, datetime('now'), datetime('now'))\`);

            db.run(\`INSERT OR REPLACE INTO Announcements (id, title, content, expiresAt, createdBy, createdAt, updatedAt)
                     VALUES (2, 'Pool Opening Schedule', 'The community pool will open for the season on June 1st. Pool hours are 6 AM to 10 PM daily. Please review the pool rules posted at the facility.', datetime('now', '+60 days'), 1, datetime('now'), datetime('now'))\`);

            // Insert sample events
            db.run(\`INSERT OR REPLACE INTO Events (id, title, description, location, startDate, endDate, createdBy, createdAt, updatedAt)
                     VALUES (1, 'Annual HOA Meeting', 'Join us for our annual HOA meeting to discuss community improvements and budget.', 'Community Center', datetime('now', '+7 days'), datetime('now', '+7 days', '+2 hours'), 1, datetime('now'), datetime('now'))\`);

            db.run(\`INSERT OR REPLACE INTO Events (id, title, description, location, startDate, endDate, createdBy, createdAt, updatedAt)
                     VALUES (2, 'Summer BBQ Social', 'Annual summer BBQ event for all residents. Bring your family and meet your neighbors!', 'Community Park', datetime('now', '+21 days'), datetime('now', '+21 days', '+4 hours'), 1, datetime('now'), datetime('now'))\`);

            // Insert sample documents
            db.run(\`INSERT OR REPLACE INTO Documents (id, title, description, fileName, filePath, fileSize, mimeType, visibility, status, uploadedBy, createdAt, updatedAt)
                     VALUES (1, 'HOA Bylaws 2024', 'Official HOA bylaws and regulations', 'hoa-bylaws-2024.pdf', '/uploads/documents/hoa-bylaws-2024.pdf', 245760, 'application/pdf', 'public', 'approved', 1, datetime('now'), datetime('now'))\`);

            db.run(\`INSERT OR REPLACE INTO Documents (id, title, description, fileName, filePath, fileSize, mimeType, visibility, status, uploadedBy, createdAt, updatedAt)
                     VALUES (2, 'Community Guidelines', 'Guidelines for maintaining community standards', 'community-guidelines.pdf', '/uploads/documents/community-guidelines.pdf', 189440, 'application/pdf', 'public', 'approved', 1, datetime('now'), datetime('now'))\`);

            // Insert sample discussions
            db.run(\`INSERT OR REPLACE INTO Discussions (id, title, content, createdBy, createdAt, updatedAt)
                     VALUES (1, 'Playground Equipment Upgrade', 'What do you think about upgrading the playground equipment in the park? I would love to hear everyone\\'s thoughts.', 2, datetime('now', '-2 days'), datetime('now', '-2 days'))\`);

            db.run(\`INSERT OR REPLACE INTO Discussions (id, title, content, createdBy, createdAt, updatedAt)
                     VALUES (2, 'Street Parking Concerns', 'Has anyone else noticed the street parking situation on Oak Street? Maybe we should discuss potential solutions.', 2, datetime('now', '-5 days'), datetime('now', '-5 days'))\`, () => {
              db.close();
              console.log('Test data seeded successfully');
            });
          });
          "

      - name: Start backend server
        working-directory: backend
        run: |
          NODE_ENV=test npm start &
          echo $! > /tmp/backend.pid
          # Wait for backend to be ready
          timeout 60 bash -c 'until curl -f http://localhost:5000/api/health 2>/dev/null; do sleep 2; done' || true
          sleep 5

      - name: Start frontend server
        working-directory: frontend
        run: |
          npm run dev &
          echo $! > /tmp/frontend.pid
          # Wait for frontend to be ready
          timeout 60 bash -c 'until curl -f http://localhost:3000 2>/dev/null; do sleep 2; done'
          sleep 3

      - name: Generate screenshots
        working-directory: frontend
        env:
          GENERATE_SCREENSHOTS: 'true'
        run: npm run generate-screenshots

      - name: Stop servers
        if: always()
        run: |
          [ -f /tmp/backend.pid ] && kill $(cat /tmp/backend.pid) || true
          [ -f /tmp/frontend.pid ] && kill $(cat /tmp/frontend.pid) || true

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: user-guide-screenshots
          path: frontend/screenshots/
          retention-days: 30

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7

      - name: Comment on PR with screenshots
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const screenshotsDir = 'frontend/screenshots';
            let comment = '## ðŸ“¸ User Guide Screenshots Generated\n\n';
            comment += 'Screenshots have been generated for the user guides. ';
            comment += 'Download the artifacts from this workflow run to view them.\n\n';

            if (fs.existsSync(screenshotsDir)) {
              const files = fs.readdirSync(screenshotsDir);
              comment += `**Total screenshots:** ${files.length}\n`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
