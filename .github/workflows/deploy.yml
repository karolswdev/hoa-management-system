name: Deploy Production

on:
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      run_migrations:
        description: 'Run database migrations'
        required: true
        default: 'true'
      build_no_cache:
        description: 'Force Docker rebuild without cache (legacy)'
        required: true
        default: 'false'

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  build-images:
    name: Build & Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      version: ${{ steps.meta.outputs.version }}
      backend_image: ${{ steps.images.outputs.backend_image }}
      frontend_image: ${{ steps.images.outputs.frontend_image }}
    env:
      VITE_APP_NAME: "Sanderson Creek HOA"
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || github.ref }}

      - name: Extract metadata
        id: meta
        run: |
          RAW_VERSION=$(git describe --tags --always --dirty)
          SAFE_VERSION=$(echo "$RAW_VERSION" | sed 's/[^0-9A-Za-z._-]/-/g')
          OWNER_LC=$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')
          echo "version=$SAFE_VERSION" >> "$GITHUB_OUTPUT"
          echo "owner=$OWNER_LC" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build & push backend image
        env:
          IMAGE: ghcr.io/${{ steps.meta.outputs.owner }}/hoa-backend:${{ steps.meta.outputs.version }}
          APP_VERSION: ${{ steps.meta.outputs.version }}
        run: |
          docker buildx build --platform linux/amd64 \
            -t "$IMAGE" \
            --build-arg APP_VERSION="$APP_VERSION" \
            -f backend/Dockerfile backend \
            --push

      - name: Build & push frontend image
        env:
          IMAGE: ghcr.io/${{ steps.meta.outputs.owner }}/hoa-frontend:${{ steps.meta.outputs.version }}
          VITE_API_BASE_URL: https://${{ secrets.DEPLOY_DOMAIN }}/api
          VITE_APP_NAME: ${{ env.VITE_APP_NAME }}
          VITE_TURNSTILE_SITE_KEY: ${{ secrets.VITE_TURNSTILE_SITE_KEY }}
          VITE_APP_VERSION: ${{ steps.meta.outputs.version }}
        run: |
          docker buildx build --platform linux/amd64 \
            -t "$IMAGE" \
            -f frontend/Dockerfile frontend \
            --build-arg VITE_API_BASE_URL="$VITE_API_BASE_URL" \
            --build-arg VITE_APP_NAME="$VITE_APP_NAME" \
            --build-arg VITE_TURNSTILE_SITE_KEY="$VITE_TURNSTILE_SITE_KEY" \
            --build-arg VITE_APP_VERSION="$VITE_APP_VERSION" \
            --push

      - name: Publish image metadata
        id: images
        run: |
          OWNER="${{ steps.meta.outputs.owner }}"
          VERSION="${{ steps.meta.outputs.version }}"
          echo "backend_image=ghcr.io/${OWNER}/hoa-backend:${VERSION}" >> "$GITHUB_OUTPUT"
          echo "frontend_image=ghcr.io/${OWNER}/hoa-frontend:${VERSION}" >> "$GITHUB_OUTPUT"

  deploy:
    name: Deploy to Linode
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: build-images
    env:
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
      DEPLOY_DOMAIN: ${{ secrets.DEPLOY_DOMAIN }}
      SSH_KEY_PATH: ${{ runner.temp }}/hoa_deploy_key
      REMOTE_SCRIPT_PATH: /tmp/hoa-remote-deploy.sh
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || github.ref }}

      - name: Validate deployment secrets
        run: |
          for var in DEPLOY_HOST DEPLOY_USER DEPLOY_DIR DEPLOY_DOMAIN; do
            if [ -z "${!var:-}" ]; then
              echo "::error ::Missing required secret: $var"
              exit 1
            fi
          done
          if [ -z "${DEPLOY_SSH_KEY:-}" ]; then
            echo "::error ::Missing required secret: DEPLOY_SSH_KEY"
            exit 1
          fi
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Prepare SSH key
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          install -m 700 -d ~/.ssh
          echo "$DEPLOY_SSH_KEY" > "$SSH_KEY_PATH"
          chmod 600 "$SSH_KEY_PATH"
          ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts

      - name: Ensure remote directory exists
        run: |
          ssh -i "$SSH_KEY_PATH" -o BatchMode=yes -o StrictHostKeyChecking=yes -o ConnectTimeout=30 \
            "$DEPLOY_USER@$DEPLOY_HOST" "mkdir -p '$DEPLOY_DIR'"

      - name: Sync repository to server
        run: |
          rsync -az --delete --delete-excluded \
            --exclude-from=deploy/rsync-exclude.txt \
            -e "ssh -i $SSH_KEY_PATH -o BatchMode=yes -o StrictHostKeyChecking=yes -o ConnectTimeout=30" \
            ./ "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_DIR/"

      - name: Upload remote deploy script
        run: |
          scp -i "$SSH_KEY_PATH" -o BatchMode=yes -o StrictHostKeyChecking=yes -o ConnectTimeout=30 \
            deploy/remote.deploy.sh "$DEPLOY_USER@$DEPLOY_HOST:$REMOTE_SCRIPT_PATH"
          ssh -i "$SSH_KEY_PATH" -o BatchMode=yes -o StrictHostKeyChecking=yes -o ConnectTimeout=30 \
            "$DEPLOY_USER@$DEPLOY_HOST" "chmod +x '$REMOTE_SCRIPT_PATH'"

      - name: Execute remote deployment
        env:
          RUN_MIGRATIONS_INPUT: ${{ github.event.inputs.run_migrations || 'true' }}
          BUILD_NO_CACHE_INPUT: ${{ github.event.inputs.build_no_cache || 'false' }}
          APP_VERSION: ${{ needs.build-images.outputs.version }}
          BACKEND_IMAGE: ${{ needs.build-images.outputs.backend_image }}
          FRONTEND_IMAGE: ${{ needs.build-images.outputs.frontend_image }}
        run: |
          ssh -i "$SSH_KEY_PATH" -o BatchMode=yes -o StrictHostKeyChecking=yes -o ConnectTimeout=30 \
            "$DEPLOY_USER@$DEPLOY_HOST" \
            REMOTE_DIR="$DEPLOY_DIR" \
            COMPOSE_FILE="docker-compose.yml" \
            DOMAIN="$DEPLOY_DOMAIN" \
            BUILD_NO_CACHE="$BUILD_NO_CACHE_INPUT" \
            RUN_MIGRATIONS="$RUN_MIGRATIONS_INPUT" \
            APP_VERSION="$APP_VERSION" \
            BACKEND_IMAGE="$BACKEND_IMAGE" \
            FRONTEND_IMAGE="$FRONTEND_IMAGE" \
            "$REMOTE_SCRIPT_PATH"
