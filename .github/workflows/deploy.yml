name: Deploy Production

on:
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      run_migrations:
        description: 'Run database migrations'
        required: true
        default: 'true'
      build_no_cache:
        description: 'Force Docker rebuild without cache (legacy)'
        required: true
        default: 'false'

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  build-images:
    name: Build & Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      version: ${{ steps.meta.outputs.version }}
      backend_image: ${{ steps.images.outputs.backend_image }}
      frontend_image: ${{ steps.images.outputs.frontend_image }}
    env:
      VITE_APP_NAME: "Sanderson Creek HOA"
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || github.ref }}

      - name: Prepare runtime env vars
        run: |
          echo "SSH_KEY_PATH=$RUNNER_TEMP/hoa_deploy_key" >> $GITHUB_ENV
          echo "REMOTE_SCRIPT_PATH=/tmp/hoa-remote-deploy.sh" >> $GITHUB_ENV

      - name: Extract metadata
        id: meta
        run: |
          RAW_VERSION=$(git describe --tags --always --dirty)
          SAFE_VERSION=$(echo "$RAW_VERSION" | sed 's/[^0-9A-Za-z._-]/-/g')
          OWNER_LC=$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')
          echo "version=$SAFE_VERSION" >> "$GITHUB_OUTPUT"
          echo "owner=$OWNER_LC" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build backend image (local)
        env:
          IMAGE: ghcr.io/${{ steps.meta.outputs.owner }}/hoa-backend:${{ steps.meta.outputs.version }}
          APP_VERSION: ${{ steps.meta.outputs.version }}
        run: |
          docker buildx build --platform linux/amd64 \
            -t "$IMAGE" \
            --build-arg APP_VERSION="$APP_VERSION" \
            -f backend/Dockerfile backend \
            --load

      - name: Build frontend image (local)
        env:
          IMAGE: ghcr.io/${{ steps.meta.outputs.owner }}/hoa-frontend:${{ steps.meta.outputs.version }}
          VITE_API_BASE_URL: https://${{ secrets.DEPLOY_DOMAIN }}/api
          VITE_APP_NAME: ${{ env.VITE_APP_NAME }}
          VITE_TURNSTILE_SITE_KEY: ${{ secrets.VITE_TURNSTILE_SITE_KEY }}
          VITE_APP_VERSION: ${{ steps.meta.outputs.version }}
        run: |
          docker buildx build --platform linux/amd64 \
            -t "$IMAGE" \
            -f frontend/Dockerfile frontend \
            --build-arg VITE_API_BASE_URL="$VITE_API_BASE_URL" \
            --build-arg VITE_APP_NAME="$VITE_APP_NAME" \
            --build-arg VITE_TURNSTILE_SITE_KEY="$VITE_TURNSTILE_SITE_KEY" \
            --build-arg VITE_APP_VERSION="$VITE_APP_VERSION" \
            --load

      - name: Create health gate network and volumes
        run: |
          docker network create hoa-health-gate-network || true
          mkdir -p ${{ runner.temp }}/health-gate-db
          mkdir -p ${{ runner.temp }}/health-gate-uploads

      - name: Start backend container for health gate
        env:
          BACKEND_IMAGE: ghcr.io/${{ steps.meta.outputs.owner }}/hoa-backend:${{ steps.meta.outputs.version }}
          APP_PORT: 3001
        run: |
          docker run -d \
            --name hoa_backend_health_gate \
            --network hoa-health-gate-network \
            -p 3001:3001 \
            -e NODE_ENV=production \
            -e PORT=$APP_PORT \
            -e JWT_SECRET=test-jwt-secret-for-health-gate \
            -e JWT_EXPIRES_IN=7d \
            -e DB_PATH=/usr/src/app/backend/database/hoa.db \
            -e MAX_FILE_SIZE_MB=10 \
            -e EMAIL_PROVIDER=console \
            -e EMAIL_FROM=noreply@example.com \
            -e EMAIL_FROM_NAME="HOA Management" \
            -e FRONTEND_BASE_URL=http://localhost:3000 \
            -v ${{ runner.temp }}/health-gate-db:/usr/src/app/backend/database \
            -v ${{ runner.temp }}/health-gate-uploads:/usr/src/app/backend/uploads \
            "$BACKEND_IMAGE"

      - name: Run database migrations in health gate
        env:
          BACKEND_IMAGE: ghcr.io/${{ steps.meta.outputs.owner }}/hoa-backend:${{ steps.meta.outputs.version }}
        run: |
          echo "Running migrations on temporary database..."
          docker run --rm \
            --network hoa-health-gate-network \
            -e NODE_ENV=production \
            -e DB_PATH=/usr/src/app/backend/database/hoa.db \
            -v ${{ runner.temp }}/health-gate-db:/usr/src/app/backend/database \
            "$BACKEND_IMAGE" \
            npx sequelize-cli db:migrate
          echo "Migrations completed successfully"

      - name: Wait for backend to be ready
        run: |
          echo "Waiting for backend to start..."
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if docker ps | grep -q hoa_backend_health_gate; then
              echo "Backend container is running"
              sleep 5
              break
            fi
            echo "Attempt $((attempt + 1))/$max_attempts: Backend not ready yet..."
            sleep 2
            attempt=$((attempt + 1))
          done

          if [ $attempt -eq $max_attempts ]; then
            echo "Backend failed to start within timeout"
            docker logs hoa_backend_health_gate || true
            exit 1
          fi

      - name: Health gate - curl /healthz endpoint
        id: health_check
        run: |
          echo "Checking /api/health endpoint..."
          max_attempts=15
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if curl -f -s http://localhost:3001/api/health > ${{ runner.temp }}/healthz-response.json; then
              echo "✅ Health check passed"
              cat ${{ runner.temp }}/healthz-response.json
              echo "health_status=passed" >> "$GITHUB_OUTPUT"
              break
            fi
            echo "Attempt $((attempt + 1))/$max_attempts: Health check failed, retrying..."
            sleep 2
            attempt=$((attempt + 1))
          done

          if [ $attempt -eq $max_attempts ]; then
            echo "❌ Health check failed after $max_attempts attempts"
            echo "Backend logs:"
            docker logs hoa_backend_health_gate || true
            exit 1
          fi

      - name: Health gate - curl /metrics endpoint
        id: metrics_check
        run: |
          echo "Checking /api/metrics endpoint..."
          if curl -f -s http://localhost:3001/api/metrics > ${{ runner.temp }}/metrics-response.json; then
            echo "✅ Metrics endpoint accessible"
            cat ${{ runner.temp }}/metrics-response.json
            echo "metrics_status=passed" >> "$GITHUB_OUTPUT"
          else
            echo "❌ Metrics endpoint check failed"
            docker logs hoa_backend_health_gate || true
            exit 1
          fi

      - name: Capture health gate logs
        if: always()
        run: |
          echo "Capturing health gate dry run logs..."
          docker logs hoa_backend_health_gate > ${{ runner.temp }}/health-gate-backend.log 2>&1 || true
          docker ps -a > ${{ runner.temp }}/health-gate-containers.log 2>&1 || true
          ls -la ${{ runner.temp }}/health-gate-db > ${{ runner.temp }}/health-gate-db-contents.log 2>&1 || true

      - name: Upload health gate dry run logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-gate-dry-run-logs
          path: |
            ${{ runner.temp }}/health-gate-backend.log
            ${{ runner.temp }}/health-gate-containers.log
            ${{ runner.temp }}/health-gate-db-contents.log
            ${{ runner.temp }}/healthz-response.json
            ${{ runner.temp }}/metrics-response.json
          retention-days: 30

      - name: Cleanup health gate containers
        if: always()
        run: |
          docker stop hoa_backend_health_gate || true
          docker rm hoa_backend_health_gate || true
          docker network rm hoa-health-gate-network || true

      - name: Push backend image to GHCR
        env:
          IMAGE: ghcr.io/${{ steps.meta.outputs.owner }}/hoa-backend:${{ steps.meta.outputs.version }}
        run: |
          echo "Health gate passed - pushing backend image to GHCR..."
          docker push "$IMAGE"
          docker tag "$IMAGE" "ghcr.io/${{ steps.meta.outputs.owner }}/hoa-backend:latest"
          docker push "ghcr.io/${{ steps.meta.outputs.owner }}/hoa-backend:latest"

      - name: Push frontend image to GHCR
        env:
          IMAGE: ghcr.io/${{ steps.meta.outputs.owner }}/hoa-frontend:${{ steps.meta.outputs.version }}
        run: |
          echo "Pushing frontend image to GHCR..."
          docker push "$IMAGE"
          docker tag "$IMAGE" "ghcr.io/${{ steps.meta.outputs.owner }}/hoa-frontend:latest"
          docker push "ghcr.io/${{ steps.meta.outputs.owner }}/hoa-frontend:latest"

      - name: Publish image metadata
        id: images
        run: |
          OWNER="${{ steps.meta.outputs.owner }}"
          VERSION="${{ steps.meta.outputs.version }}"
          echo "backend_image=ghcr.io/${OWNER}/hoa-backend:${VERSION}" >> "$GITHUB_OUTPUT"
          echo "frontend_image=ghcr.io/${OWNER}/hoa-frontend:${VERSION}" >> "$GITHUB_OUTPUT"

  deploy:
    name: Deploy to Linode
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: build-images
    env:
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
      DEPLOY_DOMAIN: ${{ secrets.DEPLOY_DOMAIN }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || github.ref }}

      - name: Configure SSH paths
        run: |
          echo "SSH_KEY_PATH=$RUNNER_TEMP/hoa_deploy_key" >> $GITHUB_ENV
          echo "REMOTE_SCRIPT_PATH=/tmp/hoa-remote-deploy.sh" >> $GITHUB_ENV

      - name: Validate deployment secrets
        run: |
          for var in DEPLOY_HOST DEPLOY_USER DEPLOY_DIR DEPLOY_DOMAIN; do
            if [ -z "${!var:-}" ]; then
              echo "::error ::Missing required secret: $var"
              exit 1
            fi
          done
          if [ -z "${DEPLOY_SSH_KEY:-}" ]; then
            echo "::error ::Missing required secret: DEPLOY_SSH_KEY"
            exit 1
          fi
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Prepare SSH key
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          install -m 700 -d ~/.ssh
          echo "$DEPLOY_SSH_KEY" > "$SSH_KEY_PATH"
          chmod 600 "$SSH_KEY_PATH"
          ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts

      - name: Ensure remote directory exists
        run: |
          ssh -i "$SSH_KEY_PATH" -o BatchMode=yes -o StrictHostKeyChecking=yes -o ConnectTimeout=30 \
            "$DEPLOY_USER@$DEPLOY_HOST" "mkdir -p '$DEPLOY_DIR'"

      - name: Sync repository to server
        run: |
          rsync -az --delete \
            --filter='P .env' \
            --exclude-from=deploy/rsync-exclude.txt \
            -e "ssh -i $SSH_KEY_PATH -o BatchMode=yes -o StrictHostKeyChecking=yes -o ConnectTimeout=30" \
            ./ "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_DIR/"

      - name: Upload remote deploy script
        run: |
          scp -i "$SSH_KEY_PATH" -o BatchMode=yes -o StrictHostKeyChecking=yes -o ConnectTimeout=30 \
            deploy/remote.deploy.sh "$DEPLOY_USER@$DEPLOY_HOST:$REMOTE_SCRIPT_PATH"
          ssh -i "$SSH_KEY_PATH" -o BatchMode=yes -o StrictHostKeyChecking=yes -o ConnectTimeout=30 \
            "$DEPLOY_USER@$DEPLOY_HOST" "chmod +x '$REMOTE_SCRIPT_PATH'"

      - name: Execute remote deployment
        env:
          RUN_MIGRATIONS_INPUT: ${{ github.event.inputs.run_migrations || 'true' }}
          BUILD_NO_CACHE_INPUT: ${{ github.event.inputs.build_no_cache || 'false' }}
          APP_VERSION: ${{ needs.build-images.outputs.version }}
          BACKEND_IMAGE: ${{ needs.build-images.outputs.backend_image }}
          FRONTEND_IMAGE: ${{ needs.build-images.outputs.frontend_image }}
        run: |
          ssh -i "$SSH_KEY_PATH" -o BatchMode=yes -o StrictHostKeyChecking=yes -o ConnectTimeout=30 \
            "$DEPLOY_USER@$DEPLOY_HOST" \
            REMOTE_DIR="$DEPLOY_DIR" \
            COMPOSE_FILE="deploy/docker-compose.prod.yml" \
            DOMAIN="$DEPLOY_DOMAIN" \
            BUILD_NO_CACHE="$BUILD_NO_CACHE_INPUT" \
            RUN_MIGRATIONS="$RUN_MIGRATIONS_INPUT" \
            APP_VERSION="$APP_VERSION" \
            BACKEND_IMAGE="$BACKEND_IMAGE" \
            FRONTEND_IMAGE="$FRONTEND_IMAGE" \
            "$REMOTE_SCRIPT_PATH"
