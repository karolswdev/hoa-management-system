<!-- anchor: system-architecture-blueprint -->
# System Architecture Blueprint: HOA Management System

**Version:** 1.0
**Date:** 2025-11-23
**Generated By:** Structural_Data_Architect

<!-- anchor: 1-introduction-goals -->
## 1. Introduction & Goals

*   **1.1. Project Vision:** Deliver an extensible yet disciplined HOA Management System extension that fortifies community governance, inclusive accessibility, poll integrity, and vendor curation while keeping the single Linode-hosted layered monolith easy for volunteers to operate.
*   **1.2. Key Objectives:**
    *   Make board leadership transparent through a configurable public roster, authenticated history views, and a protected contact workflow routed through SendGrid.
    *   Ship the Accessibility Suite with high-visibility theming, contextual help affordances, and persistent preferences spanning guests (localStorage) and members (profiles).
    *   Enable the Democracy module to provide informal polls and binding hash-chained votes plus receipt verification and optional member-wide email notices.
    *   Publish a member-moderated Vendor Directory backed by clear schema boundaries and caching, allowing future filtering without duplicating records.
    *   Harden CI/CD so npm audit and dockerized health checks block regressions before reaching the HOA’s production Linode instance.
*   **1.3. Scope:** The blueprint covers frontend React components, contexts, and admin pages; backend Express controllers, services, and SQLite schema/migrations; SendGrid-based messaging; feature flag governance via the Config table; and GitHub Actions workflow enhancements. Identity providers, third-party queues, alternative databases, or distributed microservices are out of scope.
*   **1.4. Key Assumptions:** Authentication, Docker images, SendGrid keys, and cron support already exist; SQLite remains the sole datastore; admins can manage feature flags through existing roles; residents operate primarily in English; and operational budgets demand deterministic resource use under 1GB RAM.

<!-- anchor: 2-architectural-drivers -->
## 2. Architectural Drivers

*   **2.1. Functional Requirements Summary:** Board Member Management provides rank-ordered titles, membership history, roster visibility controls, and contact flows; Accessibility Suite introduces high-contrast theming and contextual helpers; Democracy Module covers poll lifecycle, SHA256 hash chains, and email notices; Vendor Directory supplies curated listings; CI/CD adds npm audit + runtime health verifications. Each module must integrate through existing controllers/services without splintering the monolith.
*   **2.2. Non-Functional Requirements (NFRs):**
    *   **Simplicity & Stability:** Favor predictable flows, minimal dependencies, and explicit caching to respect Linode memory restrictions.
    *   **Security & Privacy:** Enforce role-based guards, CAPTCHA, hashed receipts, redacted logs, and SendGrid-only email distribution.
    *   **Performance:** Use indexes (e.g., Votes.poll_id, BoardMembers.title_id) and lightweight schema queries; keep hash calculations asynchronous but CPU-light.
    *   **Accessibility:** WCAG AA alignment with clear aria labels, tooltip text, and large-typography themes activated via feature flags.
    *   **Auditability:** Persist audit logs for votes, admin changes, emails, and feature flag toggles to resolve governance disputes.
*   **2.3. Constraints & Preferences:** Opinionated layered monolith with React/Vite + Node.js 18 Express; SQLite only; SendGrid as email provider; GitHub Actions for CI/CD with npm audit critical gating; Docker artifact under 1GB; no new managed services, message queues, or alternative runtimes; configuration stored in Config table with TTL cache; features rolled out through config-driven flags.

<!-- anchor: 3-proposed-architecture -->
## 3. Proposed Architecture (Structural View)

*   **3.1. Architectural Style:** Opinionated layered monolith (React SPA + Node.js/Express API) per the foundation ensures every enhancement reuses the existing delivery pipeline, simplifies deployments on a single Linode Nanode, and keeps cross-module interactions explicit through controllers and services instead of hidden scripts or microservices.
*   **3.2. Technology Stack Summary:**

| Layer / Concern | Technology | Notes |
| --- | --- | --- |
| Frontend SPA | React + Vite + TypeScript + Material UI | Houses CommunityWebApp + AdminConsole, integrates AccessibilityContext and feature-flag hook. |
| State & Data Fetching | React Query (or SWR) | Maintains cached REST responses and invalidation for board, polls, vendors. |
| Theming | Custom `createAppTheme` | Generates standard/high-visibility modes with typography scaling & button tweaks. |
| Backend Runtime | Node.js 18 LTS + Express | Hosts ApiGateway with controllers delegating to services (board, polls, vendors, config). |
| Business Logic Layer | Service modules inside `services/` | BoardGovernanceService, DemocracyService, VendorDirectoryService, VoteIntegrityEngine, EmailNotificationService. |
| Persistence | SQLite 3 | Primary database with migrations, indexes, and TTL-cached config reads. |
| Email | SendGrid API | Single outbound provider for board contact and poll notifications with retry logging. |
| Configuration | Config table + in-memory TTL cache | Feature flags such as `board.visibility`, `accessibility.highVis`, `polls.binding-enabled`. |
| DevOps | Docker + GitHub Actions | Builds containers, runs npm audit critical gating, executes `/healthz` curl before GHCR push. |
| Observability | Pino logs + `/healthz` + `/metrics` | Structured JSON logs with correlation IDs, accessible readiness endpoints for CI and HealthMonitor. |
| Testing | Jest + React Testing Library | Module-level coverage for controllers/services and UI contexts/themes. |

*   **3.3. System Context Diagram (C4 Level 1):**
    *   **Description:** Residents, board officials, and admin volunteers interact with the CommunityWebApp, which calls the ApiGateway to access board, poll, vendor, and configuration data persisted within SQLite. SendGrid handles outbound email, GitHub Actions enforces CI/CD, and a lightweight HealthMonitor or CI job probes the `/healthz` endpoint. Guests can only view public-facing pages depending on feature flags, ensuring board history stays private.
    *   **Diagram (PlantUML):**
        ~~~plantuml
        @startuml
        !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml
        LAYOUT_LEFT_RIGHT()
        SHOW_LEGEND()
        ' Stakeholders
        Person(resident, "Resident", "Authenticated homeowner reviewing agendas, polls, and vendor listings.")
        Person(boardMember, "Board Member", "Elected leader needing admin views, audit histories, and vote insights.")
        Person(adminVolunteer, "Admin Volunteer", "Trusted operator managing flags, content, and notifications.")
        Person_Ext(guest, "Public Guest", "Unauthenticated visitor limited to whitelisted content.")
        System_Ext(sendgrid, "SendGrid Email API", "Delivers masked board contact replies and poll notifications.")
        System_Ext(github, "GitHub Actions", "Runs CI/CD, npm audit, Docker build, and health probes.")
        System_Ext(healthmon, "Health Monitor Script", "Cron or workstation script hitting /healthz and emailing anomalies.")

        ' System boundary
        System_Boundary(hms, "HOA Management System"){
          System(webapp, "CommunityWebApp", "React SPA (Vite) hosting resident and admin experiences including Accessibility Suite.")
          System(api, "ApiGateway", "Node.js 18 Express backend exposing REST controllers and TTL config cache.")
          SystemDb(sqlite, "SQLite Data Store", "Single-file database storing users, board history, polls, votes, vendors, flags.")
          System(emailSvc, "EmailNotificationService", "In-process SendGrid integration used by board contact and democracy workflows.")
        }

        ' Relationships within boundary
        Rel(webapp, api, "Fetches data & posts board/contact/poll/vendor requests", "REST/JSON over HTTPS")
        Rel(api, sqlite, "Persists governance data, feature flags, audit events", "SQLite file I/O")
        Rel(api, emailSvc, "Invokes typed DTOs for board contact & poll notifications", "Function calls")
        Rel(emailSvc, sendgrid, "Sends emails via SendGrid SDK", "HTTPS API")
        Rel(api, github, "Exposes /healthz consumed during deploy", "HTTPS")
        Rel(healthmon, api, "Performs runtime /healthz pings", "HTTPS GET")
        Rel(adminVolunteer, api, "Executes admin CRUD + flag toggles with auth token", "REST/JSON")
        Rel(boardMember, webapp, "Uses AdminConsole views for board and poll management", "Browser + HTTPS")
        Rel(resident, webapp, "Uses CommunityWebApp for voting, help cues, vendor browsing", "Browser + HTTPS")
        Rel(guest, webapp, "Views public board roster and vendors when flags allow", "Browser + HTTPS")
        Rel(adminVolunteer, github, "Monitors CI/CD status and audit gates", "GitHub UI")
        @enduml
        ~~~

*   **3.4. Container Diagram (C4 Level 2):**
    *   **Description:** The system boundary contains two deployable frontend views (CommunityWebApp for residents/guests and AdminConsole for privileged flows) served from the same React bundle, a single ApiGateway process that encapsulates service modules, and the SQLite datastore. SendGrid, GitHub Actions, and an optional HealthMonitor interact externally. ConfigRegistry and ResidentNotificationLog are modeled as logical containers to emphasize their structural roles even though they run in-process.
    *   **Diagram (PlantUML):**
        ~~~plantuml
        @startuml
        !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
        LAYOUT_LEFT_RIGHT()
        SHOW_LEGEND()
        Person(resident, "Resident", "Homeowner with role-based access to polls and board history.")
        Person(boardMember, "Board Member", "Leader managing rosters and messaging.")
        Person(adminVolunteer, "Admin Volunteer", "Maintains flags, polls, vendors.")
        Person_Ext(guest, "Public Guest", "Views only public modules.")
        System_Ext(sendgrid, "SendGrid Email API", "External provider for outbound email.")
        System_Ext(github, "GitHub Actions", "CI/CD runner executing npm audit, docker build, and health checks.")
        System_Ext(healthmon, "HealthMonitor", "Optional cron or CLI script verifying /healthz.")

        System_Boundary(hms, "HOA Management System"){
          Container(webapp, "CommunityWebApp", "React + Vite + Material UI", "Resident/guest experience with AccessibilityContext, FeatureFlag hook, Board page, Polls, Vendors.")
          Container(adminConsole, "AdminConsole", "React Protected Views", "Board management, poll creation, vendor CRUD, feature flag UI, high-vis previews.")
          Container(api, "ApiGateway", "Node.js 18 Express", "Single backend exposing REST controllers and hosting BoardGovernanceService, DemocracyService, VendorDirectoryService, ConfigRegistry, EmailNotificationService, VoteIntegrityEngine.")
          ContainerDb(sqlite, "SQLite Database", "SQLite 3", "Stores users, board titles/members, polls, votes, vendors, configs, audits, residents notification log.")
          Container(configCache, "ConfigRegistry Cache", "In-memory TTL cache", "Caches Config table values for 60s, invalidated after admin edits.")
          Container(residentLog, "ResidentNotificationLog", "Logical table writer", "Records outbound board contact/poll email metadata for audits.")
        }

        Rel(resident, webapp, "Uses via browser", "HTTPS")
        Rel(boardMember, adminConsole, "Uses admin functions", "HTTPS + Auth")
        Rel(adminVolunteer, adminConsole, "Manages content & flags", "HTTPS + Auth")
        Rel(guest, webapp, "Reads allowed pages", "HTTPS")
        Rel(webapp, api, "REST calls for board/poll/vendor/config data", "JSON")
        Rel(adminConsole, api, "REST calls for admin CRUD and flag toggles", "JSON")
        Rel(api, sqlite, "SQL queries & transactions", "SQLite driver")
        Rel(api, configCache, "Reads flags (fallback to SQLite)", "In-process")
        Rel(adminConsole, configCache, "Receives flag snapshots via API responses", "JSON payload metadata")
        Rel(api, residentLog, "Records subject, recipients, timestamps", "Function call + SQL")
        Rel(residentLog, sqlite, "Persists notification records", "SQL")
        Rel(api, sendgrid, "Sends board contact + poll notifications", "HTTPS API via EmailNotificationService")
        Rel(github, api, "Calls /healthz after Docker launch", "curl HTTPS")
        Rel(healthmon, api, "Pings /healthz periodically", "HTTPS")
        Rel(adminConsole, github, "Displays workflow runs via embedded links", "GitHub UI")
        @enduml
        ~~~

*   **3.5. Component Diagram (C4 Level 3 - API Container):**
    *   **Description:** Inside the ApiGateway container, request flow moves from Express routers/controllers to business services, downstream helpers, and SQLite repositories. Controllers enforce authentication, rate-limiting, and feature flag evaluation, while services orchestrate persistence, caching, and email notifications. VoteIntegrityEngine is a dedicated component invoked only by DemocracyService when appending votes; ConfigRegistry is the sole interface for config keys; EmailNotificationService centralizes SendGrid payload composition and ensures ResidentNotificationLog + EmailAudit data is written atomically.
    *   **Diagram (PlantUML):**
        ~~~plantuml
        @startuml
        !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml
        LAYOUT_LEFT_RIGHT()
        SHOW_LEGEND()
        Container(api, "ApiGateway", "Node.js 18 Express", "Backend container hosting layered components.")
        ContainerDb(sqlite, "SQLite Database", "SQLite 3 file", "Primary persistence for all domain entities.")
        Component_Ext(sendgrid, "SendGrid SDK", "External email provider client library.")
        Component_Ext(rateLimiterStore, "In-memory RateLimiter", "Express middleware storing IP counters.")

        Container_Boundary(apiBoundary, "ApiGateway Components"){
          Component(boardController, "BoardController", "Express Router", "GET /board, GET /board/history, POST /board/contact, admin CRUD.")
          Component(pollController, "PollController", "Express Router", "GET /polls, POST /polls, POST /polls/{id}/votes, receipt lookup.")
          Component(vendorController, "VendorController", "Express Router", "GET/POST vendors.")
          Component(configController, "ConfigController", "Express Router", "GET /config/flags, PATCH /config/flags/{key}.")
          Component(boardService, "BoardGovernanceService", "Service Module", "Handles roster visibility, history queries, contact workflows.")
          Component(democracyService, "DemocracyService", "Service Module", "Creates polls, enforces voting windows, coordinates notifications.")
          Component(voteEngine, "VoteIntegrityEngine", "Utility Module", "Calculates prev_hash + vote_hash chain, issues receipts.")
          Component(vendorService, "VendorDirectoryService", "Service Module", "Manages vendor CRUD, filtering, member/public scopes.")
          Component(configRegistry, "ConfigRegistry", "Cache + Repository", "Reads/writes Config table with TTL caching.")
          Component(emailService, "EmailNotificationService", "Service Module", "Builds board contact + poll notification payloads, logs audit metadata.")
          Component(notificationLog, "ResidentNotificationLog Writer", "Repository Wrapper", "Persists EmailAudit + ResidentNotificationLog records.")
          Component(auditService, "AuditLogStore Adapter", "Repository Wrapper", "Writes AuditEvent records for admin actions.")
          Component(accessibilityHelper, "AccessibilityPreferenceAdapter", "Repository", "Saves high-visibility preferences linked to users.")
          Component(rateLimiter, "RateLimiterMiddleware", "Express Middleware", "Protects contact endpoints using IP/captcha tokens.")
          Component(authGuard, "AuthGuardMiddleware", "Express Middleware", "Validates session/JWT and role scopes.")
        }

        Rel(boardController, rateLimiter, "Applies IP throttling + captcha verification")
        Rel(boardController, authGuard, "Enforces member/admin scopes")
        Rel(boardController, boardService, "Delegates board roster/history/contact logic")
        Rel(boardController, emailService, "Triggers board contact email send")
        Rel(boardController, notificationLog, "Writes contact request metadata")

        Rel(pollController, authGuard, "Validates role for admin voting/poll actions")
        Rel(pollController, democracyService, "Delegates poll CRUD + vote commands")
        Rel(pollController, voteEngine, "Requests chained receipt for each vote")
        Rel(pollController, configRegistry, "Reads feature flags before exposing polls")

        Rel(vendorController, authGuard, "Ensures vendor CRUD permissions")
        Rel(vendorController, vendorService, "Handles vendor listing + creation")
        Rel(configController, authGuard, "Restricts config access to admins only")
        Rel(configController, configRegistry, "Reads/writes flag values with TTL invalidation")
        Rel(configController, auditService, "Persists FeatureFlagAudit entries")

        Rel(boardService, configRegistry, "Reads board visibility flag")
        Rel(boardService, sqlite, "Queries board titles/members, writes history")
        Rel(boardService, emailService, "Passes sanitized contact payloads")
        Rel(boardService, notificationLog, "Updates ResidentNotificationLog entries")

        Rel(democracyService, sqlite, "CRUD for polls, options, votes")
        Rel(democracyService, voteEngine, "Obtains prev_hash & new hash chain")
        Rel(democracyService, emailService, "Optional notify_members dispatch")
        Rel(democracyService, auditService, "Writes poll creation events")

        Rel(vendorService, sqlite, "Reads/writes vendor records")
        Rel(notificationLog, sqlite, "Stores EmailAudit + ResidentNotificationLog rows")
        Rel(auditService, sqlite, "Persists AuditEvent + FeatureFlagAudit records")
        Rel(accessibilityHelper, sqlite, "Reads/writes AccessibilityPreference")
        Rel(emailService, sendgrid, "Calls SendGrid API with typed payloads")
        Rel(emailService, notificationLog, "Inserts EmailAudit + resident notification summaries")
        Rel(configRegistry, sqlite, "Loads/stores ConfigFlag rows with TTL caching")
        Rel(rateLimiter, rateLimiterStore, "Keeps in-memory counters under 1GB limit")
        Rel(authGuard, sqlite, "Optionally loads user roles for verification")

        Rel_L(boardController, accessibilityHelper, "Syncs board contact help text preferences")
        Rel(democracyService, accessibilityHelper, "Reads user preference to tailor help cues in receipts")
        @enduml
        ~~~

*   **3.6. Data Model Overview & ERD:**
    *   **Description:** Core entities span governance, participation, configuration, accessibility, and auditing domains. Users link to BoardMembers, Votes, AccessibilityPreferences, and FeatureFlagAudits. BoardTitles and ConfigFlags configure visibility. Polls own PollOptions and Votes, with VoteIntegrity enforced through prev_hash/vote_hash columns, receipts, and optional user associations for binding ballots. Vendors capture curated provider info, and EmailAudit plus ResidentNotificationLog preserve communications. ThemePreset ensures theming tokens stay versioned, while AuditEvent documents admin operations.
    *   **Key Entities:** User; BoardTitle; BoardMember; BoardVisibilityConfig; ContactRequest; Poll; PollOption; Vote; Vendor; AccessibilityPreference; EmailAudit; ResidentNotificationLog; ConfigFlag; FeatureFlagAudit; ThemePreset; AuditEvent.
    *   **Diagram (PlantUML - ERD):**
        ~~~plantuml
        @startuml
        ' Entity Relationship Diagram describing foundational tables
        hide circle
        skinparam linetype ortho
        skinparam wrapWidth 200
        skinparam shadowing false

        entity "User" as User {
          *id : integer <<PK>>
          --
          name : text
          email : text
          role : text
          status : text
          phone : text
          created_at : datetime
          updated_at : datetime
        }

        entity "BoardTitle" as BoardTitle {
          *id : integer <<PK>>
          --
          title : text
          rank : integer
          description : text
          created_at : datetime
        }

        entity "BoardMember" as BoardMember {
          *id : integer <<PK>>
          --
          user_id : integer <<FK>>
          title_id : integer <<FK>>
          start_date : date
          end_date : date?
          bio : text
          created_at : datetime
        }

        entity "BoardVisibilityConfig" as BoardVisibilityConfig {
          *key : text <<PK>>
          --
          value : text
          updated_by : integer <<FK to User>>
          updated_at : datetime
        }

        entity "ContactRequest" as ContactRequest {
          *id : integer <<PK>>
          --
          requestor_email : text
          subject : text
          message : text
          captcha_token : text
          status : text
          submitted_at : datetime
        }

        entity "Poll" as Poll {
          *id : integer <<PK>>
          --
          title : text
          description : text
          type : text
          is_anonymous : boolean
          notify_members : boolean
          start_at : datetime
          end_at : datetime
          created_by : integer <<FK to User>>
        }

        entity "PollOption" as PollOption {
          *id : integer <<PK>>
          --
          poll_id : integer <<FK>>
          text : text
          order_index : integer
        }

        entity "Vote" as Vote {
          *id : integer <<PK>>
          --
          poll_id : integer <<FK>>
          user_id : integer?
          option_id : integer <<FK>>
          timestamp : datetime
          prev_hash : text
          vote_hash : text
          receipt_code : text
        }

        entity "Vendor" as Vendor {
          *id : integer <<PK>>
          --
          name : text
          service_category : text
          contact_info : text
          rating : integer
          notes : text
          created_by : integer <<FK to User>>
          visibility_scope : text
        }

        entity "AccessibilityPreference" as AccessibilityPreference {
          *id : integer <<PK>>
          --
          user_id : integer?
          is_high_visibility : boolean
          last_updated : datetime
          source : text
        }

        entity "EmailAudit" as EmailAudit {
          *id : integer <<PK>>
          --
          template : text
          recipient_count : integer
          request_payload_hash : text
          sent_at : datetime
          status : text
        }

        entity "ResidentNotificationLog" as ResidentNotificationLog {
          *id : integer <<PK>>
          --
          email_audit_id : integer <<FK>>
          subject : text
          recipients_summary : text
          related_entity : text
          related_id : integer
          created_at : datetime
        }

        entity "ConfigFlag" as ConfigFlag {
          *id : integer <<PK>>
          --
          key : text
          value : text
          description : text
          scope : text
          updated_at : datetime
        }

        entity "FeatureFlagAudit" as FeatureFlagAudit {
          *id : integer <<PK>>
          --
          flag_key : text
          old_value : text
          new_value : text
          changed_by : integer <<FK to User>>
          changed_at : datetime
          note : text
        }

        entity "ThemePreset" as ThemePreset {
          *id : integer <<PK>>
          --
          mode : text
          primary_color : text
          background_color : text
          font_scale : decimal
          button_padding : text
          updated_at : datetime
        }

        entity "AuditEvent" as AuditEvent {
          *id : integer <<PK>>
          --
          entity : text
          entity_id : integer
          action : text
          actor_id : integer <<FK to User>>
          metadata_json : text
          timestamp : datetime
        }

        ' Relationships
        User ||--o{ BoardMember : "serves as"
        BoardTitle ||--o{ BoardMember : "assigns title"
        User ||--o{ Poll : "creates"
        Poll ||--o{ PollOption : "contains"
        Poll ||--o{ Vote : "records votes"
        PollOption ||--o{ Vote : "selected option"
        User ||--o{ Vote : "casts (nullable for anonymous)"
        User ||--o{ Vendor : "curates vendor"
        User ||--o{ AccessibilityPreference : "stores default mode"
        User ||--o{ FeatureFlagAudit : "changes flag"
        ConfigFlag ||--o{ FeatureFlagAudit : "audited"
        ConfigFlag ||--o{ BoardVisibilityConfig : "specialized record"
        ContactRequest ||--o{ EmailAudit : "triggers email send"
        EmailAudit ||--o{ ResidentNotificationLog : "summarized in"
        Poll ||--o{ EmailAudit : "notify_members history"
        Vote ||--o{ AuditEvent : "hash chain logs"
        Vendor ||--o{ AuditEvent : "CRUD recorded"
        User ||--o{ AuditEvent : "performs action"
        ThemePreset ||--o{ AccessibilityPreference : "references mode"
        ResidentNotificationLog ||--o{ AuditEvent : "notification metadata"
        @enduml
        ~~~

---

<!-- anchor: structural-data-architect-output -->
## Structural & Data Architect Output - `02_System_Structure_and_Data.md`

| Project Scale | Line Count | Diagram Complexity |
|---------------|------------|-------------------|
| **Small** | 200-350 lines | - 1 Context diagram (30-40 lines)<br>- 1 Container diagram (40-60 lines)<br>- Simple ERD (20-30 lines)<br>- Minimal component detail |
| **Medium** | 500-800 lines | - Context diagram (50-70 lines)<br>- Container diagram (80-120 lines)<br>- Component diagram (60-100 lines)<br>- Detailed ERD (40-80 lines) |
| **Large** | 1000-1500 lines | - Complex Context (80-120 lines)<br>- Multiple Container views (150-250 lines)<br>- 2-3 Component diagrams (200-300 lines)<br>- Multi-schema ERD (100-150 lines) |
| **Enterprise** | 1800-2500 lines | - Enterprise Context (150-200 lines)<br>- Multiple system boundaries (300-400 lines)<br>- 4-6 Component diagrams (400-600 lines)<br>- Multi-schema ERD (200-300 lines) |

**Content Distribution:**
- Introduction & Goals: 10-15%
- Architectural Drivers: 10-15%
- Diagrams (PlantUML): 50-60%
- Descriptions & Explanations: 20-25%

**Quality Guidelines:**

MUST adhere to the specified line count range. Diagram content MUST be 50-60% of total lines. All required diagrams (Context, Container, Component, ERD) are MANDATORY. Outputs below minimum are INCOMPLETE. Outputs above maximum are OVER-DETAILED.
    *   **Data Governance Notes:** All governance tables enforce NOT NULL constraints on identifiers, leverage ISO date formats for compatibility with lightweight exports, and prohibit destructive updates—board history rows close with `end_date` rather than being deleted, polls never lose option rows once created, and vote corrections append compensating entries referencing their prior `vote_hash` in `AuditEvent.metadata_json`.
    *   **Indexing & Migration Responsibilities:**
        *   `BoardMembers` gains composite indexes on `(title_id, start_date)` for sorting and `(user_id, end_date)` for detecting overlapping assignments.
        *   `Votes` indexes `(poll_id, timestamp)` plus `(vote_hash)` to accelerate receipt validation while keeping storage light.
        *   `Vendors` adds `(visibility_scope, service_category)` to support public/member filtering without table scans.
        *   Each migration pairs schema DDL with seed scripts for `BoardTitles`, `ThemePreset`, and baseline `ConfigFlag` values to guarantee deterministic deployments on fresh Linode hosts.
    *   **Flag Key Ownership Mapping:**

        | Flag Key | Purpose | Owning Service | Cache TTL |
        | --- | --- | --- | --- |
        | `board.visibility` | Toggles public exposure of current roster | BoardGovernanceService | 60s |
        | `board.history-visibility` | Reinforces members-only access to history view | BoardGovernanceService | 60s |
        | `accessibility.high-vis-default` | Default AccessibilityContext mode for guests | AccessibilityContextService | 60s |
        | `polls.binding-enabled` | Allows binding vote type selection | DemocracyService | 60s |
        | `polls.notify-members-enabled` | Shows notification checkbox in AdminConsole | DemocracyService & EmailNotificationService | 60s |
        | `vendors.public-categories` | Determines which vendor categories appear for guests | VendorDirectoryService | 60s |
    *   **Privacy & Retention Considerations:** Email addresses and message bodies in `ContactRequest` are redacted inside pino logs, while `EmailAudit` only stores hashed payload signatures. `ResidentNotificationLog` retains summary lines for 90 days before archival export to encrypted storage; the transactional records stay within SQLite indefinitely to preserve traceability for HOA disputes.
    *   **Theming & Accessibility Persistence:** `ThemePreset` entries enumerate both standard and high-visibility palettes used by `createAppTheme`, and the `AccessibilityPreference.source` field distinguishes between `localStorage` and `profile` updates so backend services can respect guest-only states without persisting PII. Synchronization occurs when authenticated users toggle high-visibility mode: the frontend posts the new preference, ApiGateway updates SQLite, and ConfigRegistry invalidates cached defaults to reflect personal overrides where permitted.
    *   **Data Access Boundaries:** Controllers never access SQLite directly; instead they call services that depend on repository helpers. These helpers encapsulate SQL statements per entity, emit structured logs with correlation IDs, and expose read-only projections (e.g., vendor summaries) to React Query so no component bypasses the ApiGateway contract. This separation preserves the layered monolith discipline even as schema volume grows.
    *   **Entity Access Pattern Matrix:**

        | Entity | Primary Writers | Primary Readers | Feature Flag Dependencies |
        | --- | --- | --- | --- |
        | `BoardTitle` | AdminConsole via BoardController | CommunityWebApp (board roster), ApiGateway caches | `board.visibility` governs guest exposure |
        | `BoardMember` | AdminConsole assignments | CommunityWebApp, AuditEvent exporter | `board.visibility`, `board.history-visibility` |
        | `ContactRequest` | Board contact form submission | BoardGovernanceService + ResidentNotificationLog | `board.contact-enabled` (implicit) |
        | `Poll` | AdminConsole poll editor | CommunityWebApp poll list/detail, DemocracyService scheduler | `polls.binding-enabled`, `polls.notify-members-enabled` |
        | `PollOption` | AdminConsole | CommunityWebApp | inherits parent poll flags |
        | `Vote` | CommunityWebApp via PollDetail | DemocracyService receipts, `/receipts/{hash}` | `polls.binding-enabled` toggles hash requirements |
        | `Vendor` | AdminConsole vendor CRUD | CommunityWebApp + AdminConsole filters | `vendors.public-categories` |
        | `AccessibilityPreference` | CommunityWebApp Toggle, ApiGateway sync | AccessibilityContext bootstrap endpoint | `accessibility.high-vis-default` |
        | `ConfigFlag` | AdminConsole FeatureFlag UI | ApiGateway ConfigRegistry, frontend bootstrapper | n/a |
        | `FeatureFlagAudit` | ConfigController | AdminConsole history drawer | n/a |
        | `EmailAudit` | EmailNotificationService | AdminConsole notification history | `polls.notify-members-enabled` |
        | `ResidentNotificationLog` | EmailNotificationService | AdminConsole + reports | `polls.notify-members-enabled`, board contact visibility |

    *   **Migration & Release Cadence:** Feature branches ship schema migrations alongside service/controller updates, and CI enforces `npm run migrate:check` before docker build. Each migration script includes rollback guards to prevent data loss, yet production rollbacks remain manual to protect audit trails. Release notes must call out new feature flag keys and default values so administrators can stage rollouts without downtime.
    *   **Backup & Export Strategy:** After each deployment, a cron or GitHub Action downloads the SQLite file (read-only) and uploads it to an encrypted HOA drive. Democracy vote data additionally exports CSV snapshots containing `vote_hash` + `prev_hash` pairs for offline validation. No anonymization occurs beyond hashed receipts; instead, access to exports is restricted to board officers, satisfying transparency requirements without violating constraints.
    *   **Inter-module Data Contracts:** BoardGovernanceService exposes DTOs containing roster visibility metadata, DemocracyService returns vote receipts plus hash chain context, VendorDirectoryService returns normalized categories + redacted contact info for guests, and ConfigRegistry returns typed values annotated with TTL expiration. These DTOs ensure React Query hooks remain stable even if schema fields expand later.
    *   **CI/CD Data Checks:** The enhanced `deploy.yml` workflow spins up the docker image, runs migrations against a temporary SQLite volume, seeds baseline data, and curls `/healthz`. The health response includes database connectivity status, flag cache freshness, and theme preset checksum, allowing the pipeline to catch misconfigurations before pushing to GHCR.
    *   **Service-to-Entity Responsibility Matrix:**

        | Service | Entities Owned | Key Operations |
        | --- | --- | --- |
        | BoardGovernanceService | `BoardTitle`, `BoardMember`, `BoardVisibilityConfig`, `ContactRequest` | Title CRUD, roster queries, contact persistence, SendGrid dispatch coordination. |
        | DemocracyService | `Poll`, `PollOption`, `Vote`, `EmailAudit`, `ResidentNotificationLog` | Poll creation, option ordering, transactional vote writes with hash chaining, notify_members fan-out. |
        | VendorDirectoryService | `Vendor`, `AuditEvent` | Vendor CRUD, moderation tagging, guest/member filtering, action logging. |
        | ConfigRegistry | `ConfigFlag`, `FeatureFlagAudit`, `ThemePreset` | Typed flag reads/writes, TTL caching, theme token publication. |
        | AccessibilityContextService | `AccessibilityPreference`, `ThemePreset` | Preference synchronization, context bootstrap payloads, helper text definitions. |
        | EmailNotificationService | `EmailAudit`, `ResidentNotificationLog` | Payload templating, SendGrid invocation, audit logging with retry metadata. |

    *   **SQLite Optimization Notes:** DemocracyService executes votes within explicit `BEGIN IMMEDIATE` transactions to guarantee sequential hash chains, while board history queries rely on covering indexes and `LIMIT/OFFSET` pagination. Vacuuming is scheduled monthly (post-backup) to reclaim space from closed board terms and vendor revisions, protecting the 1GB storage ceiling without sacrificing referential integrity.
    *   **Data Exposure Guardrails:** `/board/history` and `/vendors` responses include `visibility_scope` metadata so the frontend can hide restricted data when users lack privileges. Controllers sanitize all text fields via shared validators before insertion, and any data returned to guests strips email/phone fields entirely. Logs store only hashed identifiers when referencing residents or vote receipts, aligning with the foundation’s privacy mandate.
    *   **Config Flag Lifecycle:** Feature flags follow a defined lifecycle—`draft` in ConfigFlag.description, `pilot` once a subset of admins enables them, and `general` when the HOA board ratifies production rollout. Each transition logs an entry in `FeatureFlagAudit.note`, ensuring release retrospectives can trace exactly when Accessibility Suite, Democracy, or Vendor modules became publicly visible.
    *   **Data Residency & Compliance:** All SQLite files reside on the Linode NVMe volume with full-disk encryption handled at the hypervisor layer; exports move to HOA-controlled encrypted drives only after board approval. Because the HOA operates domestically, GDPR/CCPA obligations remain light, yet the architecture documents retention windows for email logs and clarifies that vote hashes are immutable unless a legal directive requires producing a compensating entry.
    *   **Future Extension Hooks:** Additional modules (e.g., maintenance ticketing) can slot into the same layered monolith by adding new controllers/services plus ConfigFlag keys. Schema additions must reuse the migration, logging, and audit conventions outlined here so historical accountability and accessibility expectations persist across roadmap phases.
    *   **Operational Runbooks:** The blueprint requires concise runbooks stored with the repo describing how to rotate board titles, regenerate poll receipts for audits, replay vendor migrations, and reseed theme presets. Each runbook references the same controllers/services named above so volunteers can execute CLI commands or API calls without learning hidden admin scripts.
    *   **Data Quality Checks:** Nightly cron (or manual job) executes read-only validations: ensure every active `BoardMember` has exactly one `BoardTitle`, confirm `Vote.prev_hash` chains are continuous per poll, verify vendor visibility scopes align with current flags, and measure AccessibilityPreference adoption for telemetry. Failures emit structured logs and optional admin emails, giving early warning before resident-facing issues surface.
    *   **Hash Chain Verification Workflow:** DemocracyService exposes an admin endpoint that recomputes `vote_hash` sequences nightly, comparing persisted values with recalculated SHA256 strings. Any mismatch freezes the poll (disabling new votes), alerts admins, and logs an `AuditEvent` with remediation instructions, preserving the tamper-evident guarantee demanded by the roadmap.
    *   **Vendor Moderation Workflow:** VendorDirectoryService tracks a `status` metadata field (pending, approved, denied) even if the public response omits it; AdminConsole surfaces this field for reviewers, and new submissions stay hidden until an admin flips status to approved. Each transition writes to `AuditEvent` and respects `vendors.public-categories` so only the permitted categories leak to guests.
    *   **Board Contact Safeguards:** POST `/board/contact` enforces CAPTCHA validation, rate limits per IP and per email, strips HTML, and writes to `ContactRequest` with status transitions (`pending`, `sent`, `failed`). If SendGrid returns an error, EmailNotificationService retries with exponential backoff and flags the request for admin review, preventing silent loss of resident outreach.
    *   **Accessibility Telemetry:** AccessibilityContext posts anonymized toggle events (flag-only, no user identifiers) to an internal metrics endpoint so admins can see adoption trends. These aggregates live in a lightweight `metrics_accessibility` view within SQLite, giving UX stewards real evidence of high-visibility impact without breaching privacy constraints.
    *   **Health Endpoint Payload:** `/healthz` returns JSON with `version`, `db.status`, `config_cache.age_seconds`, and `theme_checksum`. Deploy pipeline rejects any response where cache age exceeds TTL or sqlite connection fails, ensuring stale flag caches cannot mislead the frontend about board visibility or accessibility defaults.
    *   **Metrics Endpoint Outline:** `/metrics` emits Prometheus-format counters for board contact submissions, poll votes, vendor CRUD actions, and accessibility toggle events. Each counter labels success/failure states, enabling GitHub Actions or HealthMonitor scripts to detect anomalies (e.g., spike in failed emails) without needing external observability stacks.
    *   **Config Cache Invalidation:** Whenever ConfigController updates a flag, it publishes an in-process event notifying ConfigRegistry to drop cached entries and refresh on the next read, keeping board visibility, democracy settings, and accessibility defaults synchronized within 60 seconds even under sustained traffic.
    *   **Feature Flag Telemetry Hooks:** FeatureFlagAdminUI posts structured events whenever admins toggle a flag, and those events capture the acting user, rationale, and before/after values so downstream analytics (or simple CSV exports) can reconstruct rollout stories even if `FeatureFlagAudit` needs to be queried outside the app.
