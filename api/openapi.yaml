openapi: 3.0.3
info:
  title: HOA Management System API
  description: |
    REST API for the Sanderson Creek HOA Management System.

    ## Board Governance Features

    The board governance module provides:
    - Public/member access to current board roster (controlled by `board.visibility` feature flag)
    - Members-only access to historical board composition (controlled by `board.history-visibility` feature flag)
    - Public contact form with CAPTCHA and rate limiting
    - Admin CRUD operations for board titles and member assignments

    ## Democracy Module Features

    The democracy module provides transparent, hash-chained voting:
    - Poll creation and management (admin only)
    - Member voting with cryptographic receipt generation
    - Receipt verification for vote integrity
    - Optional member notifications via email
    - Support for informal, binding, and straw-poll types
    - Anonymous and identified voting modes

    ## Vendor Directory Features

    The vendor directory module provides curated vendor listings with moderation:
    - Public/member/admin tiered visibility with category filtering
    - Member submissions with admin moderation workflow
    - Rating and contact information managed by admins
    - Guest access limited to approved vendors in public categories
    - TTL-cached config for `vendors.public-categories` (60s)
    - Full audit trail for vendor CRUD and moderation actions

    ## Feature Flags

    - **board.visibility**: Controls roster exposure (`public` or `members-only`, 60s cache TTL)
    - **board.history-visibility**: Controls history access (`public` or `members-only`, 60s cache TTL)
    - **polls.binding-enabled**: Allows creation of binding vote type polls (60s cache TTL)
    - **polls.notify-members-enabled**: Enables email notifications for poll announcements (60s cache TTL)
    - **vendors.public-categories**: Comma-separated list of vendor categories visible to guests (60s cache TTL)

    ## Rate Limiting

    - Default: 100 requests per 15 minutes per IP
    - Board Contact: 3 requests per hour per IP+email combination
    - Rate limit responses include `RateLimit-*` headers and return HTTP 429 with JSON error

    ## Authentication

    Admin endpoints require JWT Bearer token authentication with admin role.
    Some endpoints support optional authentication to adjust visibility.
  version: 1.0.0
  contact:
    name: HOA Management System Support
    email: support@sandersoncreekhoa.com
  license:
    name: MIT

servers:
  - url: http://localhost:3001/api
    description: Development server
  - url: https://api.sandersoncreekhoa.com/api
    description: Production server

tags:
  - name: Board
    description: Board governance endpoints for roster, history, and contact
  - name: Board Admin
    description: Administrative endpoints for managing board members and titles
  - name: Polls
    description: Democracy module endpoints for polls and voting
  - name: Polls Admin
    description: Administrative endpoints for poll management and integrity verification
  - name: Vendors
    description: Vendor directory endpoints for residents and guests
  - name: Vendors Admin
    description: Administrative endpoints for vendor moderation and management

paths:
  /board:
    get:
      tags:
        - Board
      summary: Get current board roster
      description: |
        Returns the current board roster based on the `board.visibility` feature flag.

        - If `board.visibility` is `public`, returns roster to all users
        - If `board.visibility` is `members-only`, returns roster only to authenticated members
        - Unauthenticated users receive empty roster when visibility is members-only

        Results are sorted by board title rank (ascending).
      operationId: getCurrentRoster
      security:
        - {}
        - BearerAuth: []
      responses:
        '200':
          description: Board roster retrieved successfully
          headers:
            RateLimit-Limit:
              schema:
                type: integer
              description: Maximum requests per window
            RateLimit-Remaining:
              schema:
                type: integer
              description: Remaining requests in current window
            RateLimit-Reset:
              schema:
                type: integer
              description: Time when rate limit resets (Unix timestamp)
          content:
            application/json:
              schema:
                type: object
                required:
                  - roster
                  - count
                properties:
                  roster:
                    type: array
                    items:
                      $ref: '#/components/schemas/RosterMember'
                  count:
                    type: integer
                    description: Number of roster members returned
              examples:
                public:
                  summary: Public roster response
                  value:
                    roster:
                      - id: 1
                        user:
                          id: 10
                          name: "Jane Smith"
                          email: "jane@example.com"
                        title:
                          id: 1
                          title: "President"
                          rank: 1
                        start_date: "2024-01-01"
                        bio: "Community leader with 5 years of HOA experience"
                        created_at: "2024-01-01T00:00:00.000Z"
                      - id: 2
                        user:
                          id: 15
                          name: "John Doe"
                          email: "john@example.com"
                        title:
                          id: 2
                          title: "Vice President"
                          rank: 2
                        start_date: "2024-01-01"
                        bio: null
                        created_at: "2024-01-01T00:00:00.000Z"
                    count: 2
                membersOnly:
                  summary: Empty response for guests when members-only
                  value:
                    roster: []
                    count: 0
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /board/history:
    get:
      tags:
        - Board
      summary: Get board history
      description: |
        Returns historical board members (past board members with end dates).

        - Controlled by `board.history-visibility` feature flag
        - If flag is `members-only` and user is not authenticated, returns HTTP 403
        - Results sorted by end_date descending, then by title rank ascending
      operationId: getBoardHistory
      security:
        - {}
        - BearerAuth: []
      responses:
        '200':
          description: Board history retrieved successfully
          headers:
            RateLimit-Limit:
              schema:
                type: integer
            RateLimit-Remaining:
              schema:
                type: integer
            RateLimit-Reset:
              schema:
                type: integer
          content:
            application/json:
              schema:
                type: object
                required:
                  - history
                  - count
                properties:
                  history:
                    type: array
                    items:
                      $ref: '#/components/schemas/HistoricalMember'
                  count:
                    type: integer
                    description: Number of historical members returned
              examples:
                success:
                  summary: Historical board members
                  value:
                    history:
                      - id: 3
                        user:
                          id: 8
                          name: "Alice Johnson"
                          email: "alice@example.com"
                        title:
                          id: 1
                          title: "President"
                          rank: 1
                        start_date: "2022-01-01"
                        end_date: "2023-12-31"
                        bio: "Former president"
                        created_at: "2022-01-01T00:00:00.000Z"
                    count: 1
        '403':
          description: Forbidden - History is members-only and user is not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Board history is only available to authenticated members"
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /board/contact:
    post:
      tags:
        - Board
      summary: Submit contact request to board
      description: |
        Public endpoint for submitting contact requests to the board.

        **Security Requirements:**
        - Cloudflare Turnstile CAPTCHA validation required
        - Rate limited to 3 requests per hour per IP+email combination

        **Workflow:**
        1. Validates required fields and CAPTCHA token
        2. Sanitizes subject and message (strips HTML tags)
        3. Creates ContactRequest record with `pending` status
        4. Retrieves current board member emails
        5. Sends email to all board members via SendGrid
        6. Updates ContactRequest status to `sent` or `failed`

        **Error Handling:**
        - Returns 503 if no board members are available
        - Returns 502 if SendGrid fails to send email
        - Returns 429 if rate limit exceeded
        - Returns 400 if CAPTCHA validation fails or required fields missing
      operationId: submitContactRequest
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContactRequest'
            examples:
              valid:
                summary: Valid contact request
                value:
                  requestor_email: "resident@example.com"
                  subject: "Question about pool hours"
                  message: "What are the updated pool hours for summer?"
                  captcha_token: "0.abc123..."
                  captchaToken: "0.abc123..."
      responses:
        '201':
          description: Contact request submitted successfully
          headers:
            RateLimit-Limit:
              schema:
                type: integer
            RateLimit-Remaining:
              schema:
                type: integer
            RateLimit-Reset:
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContactResponse'
              example:
                message: "Contact request submitted successfully"
                id: 42
                status: "sent"
                submitted_at: "2025-01-11T12:00:00.000Z"
        '400':
          description: Bad request - Missing required fields or CAPTCHA validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingFields:
                  summary: Missing required fields
                  value:
                    message: "Missing required fields: requestor_email, subject, message"
                captchaFailed:
                  summary: CAPTCHA validation failed
                  value:
                    message: "Captcha verification failed."
                captchaMissing:
                  summary: CAPTCHA token missing
                  value:
                    message: "Captcha token is required."
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '502':
          description: Bad Gateway - SendGrid email delivery failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Failed to send contact request to board members"
        '503':
          description: Service Unavailable - No board members available to receive message
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Unable to process contact request at this time"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /board/titles:
    get:
      tags:
        - Board
      summary: Get all board titles
      description: |
        Public endpoint returning all available board titles.
        Results sorted by rank (ascending).
      operationId: getAllBoardTitles
      responses:
        '200':
          description: Board titles retrieved successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - titles
                  - count
                properties:
                  titles:
                    type: array
                    items:
                      $ref: '#/components/schemas/BoardTitle'
                  count:
                    type: integer
              example:
                titles:
                  - id: 1
                    title: "President"
                    rank: 1
                    description: null
                  - id: 2
                    title: "Vice President"
                    rank: 2
                    description: null
                  - id: 3
                    title: "Treasurer"
                    rank: 3
                    description: null
                count: 3
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Board Admin
      summary: Create board title
      description: |
        Admin-only endpoint to create a new board title.

        **Validation:**
        - Title must be unique
        - Rank must be provided

        **Constraints:**
        - Returns 409 if title already exists
      operationId: createBoardTitle
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BoardTitleInput'
            example:
              title: "Secretary"
              rank: 4
      responses:
        '201':
          description: Board title created successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - message
                  - boardTitle
                properties:
                  message:
                    type: string
                  boardTitle:
                    $ref: '#/components/schemas/BoardTitle'
              example:
                message: "Board title created successfully"
                boardTitle:
                  id: 4
                  title: "Secretary"
                  rank: 4
                  description: null
        '400':
          description: Bad request - Missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Missing required fields: title, rank"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Conflict - Board title already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Board title already exists"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /board/titles/{id}:
    put:
      tags:
        - Board Admin
      summary: Update board title
      description: |
        Admin-only endpoint to update an existing board title.

        **Allowed Updates:**
        - title
        - rank

        All other fields are filtered out.
      operationId: updateBoardTitle
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Board title ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                rank:
                  type: integer
            example:
              title: "Chief Secretary"
              rank: 4
      responses:
        '200':
          description: Board title updated successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - message
                  - boardTitle
                properties:
                  message:
                    type: string
                  boardTitle:
                    $ref: '#/components/schemas/BoardTitle'
              example:
                message: "Board title updated successfully"
                boardTitle:
                  id: 4
                  title: "Chief Secretary"
                  rank: 4
                  description: null
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Board title not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Board title not found"
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Board Admin
      summary: Delete board title
      description: |
        Admin-only endpoint to delete a board title.

        **Constraints:**
        - Cannot delete title if any members (active or historical) are assigned to it
        - Returns 409 if constraint violated
      operationId: deleteBoardTitle
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Board title ID
          schema:
            type: integer
      responses:
        '200':
          description: Board title deleted successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - message
                properties:
                  message:
                    type: string
              example:
                message: "Board title deleted successfully"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Board title not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Board title not found"
        '409':
          description: Conflict - Cannot delete title with assigned members
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Cannot delete board title with active or historical members"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /board/members:
    post:
      tags:
        - Board Admin
      summary: Create board member
      description: |
        Admin-only endpoint to assign a user to a board position.

        **Validation:**
        - User cannot have more than one active board position
        - Returns 409 if user already has an active position

        **Behavior:**
        - Sets end_date to null (active position)
        - Bio is optional
      operationId: createBoardMember
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BoardMemberInput'
            example:
              user_id: 10
              title_id: 1
              start_date: "2024-01-01"
              bio: "Experienced community leader"
      responses:
        '201':
          description: Board member created successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - message
                  - boardMember
                properties:
                  message:
                    type: string
                  boardMember:
                    $ref: '#/components/schemas/BoardMember'
              example:
                message: "Board member created successfully"
                boardMember:
                  id: 5
                  user_id: 10
                  title_id: 1
                  start_date: "2024-01-01"
                  end_date: null
                  bio: "Experienced community leader"
                  created_at: "2024-01-11T12:00:00.000Z"
        '400':
          description: Bad request - Missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Missing required fields: user_id, title_id, start_date"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Conflict - User already has an active board position
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "User already has an active board position"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /board/members/{id}:
    put:
      tags:
        - Board Admin
      summary: Update board member
      description: |
        Admin-only endpoint to update board member details.

        **Allowed Updates:**
        - title_id (change position)
        - start_date
        - end_date (set to mark position as ended)
        - bio

        All other fields are filtered out.
        User ID cannot be changed after creation.
      operationId: updateBoardMember
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Board member ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title_id:
                  type: integer
                start_date:
                  type: string
                  format: date
                end_date:
                  type: string
                  format: date
                  nullable: true
                bio:
                  type: string
                  nullable: true
            example:
              end_date: "2024-12-31"
              bio: "Completed term with distinction"
      responses:
        '200':
          description: Board member updated successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - message
                  - boardMember
                properties:
                  message:
                    type: string
                  boardMember:
                    $ref: '#/components/schemas/BoardMember'
              example:
                message: "Board member updated successfully"
                boardMember:
                  id: 5
                  user_id: 10
                  title_id: 1
                  start_date: "2024-01-01"
                  end_date: "2024-12-31"
                  bio: "Completed term with distinction"
                  created_at: "2024-01-11T12:00:00.000Z"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Board member not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Board member not found"
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Board Admin
      summary: Delete board member
      description: |
        Admin-only endpoint to permanently delete a board member record.

        **Use Cases:**
        - Correcting data entry errors
        - Removing duplicate records

        **Note:** For ending a board term, use PUT to set end_date instead.
      operationId: deleteBoardMember
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Board member ID
          schema:
            type: integer
      responses:
        '200':
          description: Board member deleted successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - message
                properties:
                  message:
                    type: string
              example:
                message: "Board member deleted successfully"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Board member not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Board member not found"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /polls:
    get:
      tags:
        - Polls
      summary: Get active and scheduled polls
      description: |
        Returns polls filtered by optional type and status parameters.

        **Access:**
        - Public and member access (no authentication required)
        - Optional authentication to adjust visibility of certain polls

        **Filtering:**
        - `type`: Filter by poll type (informal, binding, straw-poll)
        - `status`: Filter by status (active, scheduled, closed)

        **Feature Flags:**
        - Binding polls only appear if `polls.binding-enabled` is `true`

        **Status Determination:**
        - `scheduled`: Poll start time is in the future
        - `active`: Current time is between start_at and end_at
        - `closed`: Poll end time has passed
      operationId: getPolls
      security:
        - {}
        - BearerAuth: []
      parameters:
        - name: type
          in: query
          description: Filter by poll type
          schema:
            type: string
            enum: [informal, binding, straw-poll]
        - name: status
          in: query
          description: Filter by poll status
          schema:
            type: string
            enum: [active, scheduled, closed]
      responses:
        '200':
          description: Polls retrieved successfully
          headers:
            RateLimit-Limit:
              schema:
                type: integer
            RateLimit-Remaining:
              schema:
                type: integer
            RateLimit-Reset:
              schema:
                type: integer
          content:
            application/json:
              schema:
                type: object
                required:
                  - polls
                  - count
                  - serverTime
                properties:
                  polls:
                    type: array
                    items:
                      $ref: '#/components/schemas/PollSummary'
                  count:
                    type: integer
                  serverTime:
                    type: string
                    format: date-time
                    description: Server timestamp for countdown calculations
              examples:
                informal:
                  summary: Informal poll example
                  value:
                    polls:
                      - id: 1
                        title: "Should we add a new playground?"
                        description: "Community feedback on playground location"
                        type: "informal"
                        is_anonymous: false
                        start_at: "2025-01-15T00:00:00.000Z"
                        end_at: "2025-01-22T23:59:59.000Z"
                        status: "active"
                        options:
                          - id: 1
                            text: "Near the pool"
                            order_index: 0
                          - id: 2
                            text: "Near the tennis courts"
                            order_index: 1
                        created_by: "Admin User"
                        created_at: "2025-01-10T12:00:00.000Z"
                    count: 1
                    serverTime: "2025-01-18T14:30:00.000Z"
                binding:
                  summary: Binding poll example
                  value:
                    polls:
                      - id: 2
                        title: "Annual Budget Approval"
                        description: "Vote to approve the 2025 budget"
                        type: "binding"
                        is_anonymous: false
                        start_at: "2025-02-01T00:00:00.000Z"
                        end_at: "2025-02-07T23:59:59.000Z"
                        status: "scheduled"
                        options:
                          - id: 3
                            text: "Approve budget"
                            order_index: 0
                          - id: 4
                            text: "Reject budget"
                            order_index: 1
                        created_by: "Admin User"
                        created_at: "2025-01-15T09:00:00.000Z"
                    count: 1
                    serverTime: "2025-01-18T14:30:00.000Z"
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Polls Admin
      summary: Create a new poll
      description: |
        Admin-only endpoint to create a new poll with options.

        **Validation:**
        - Title, type, start_at, end_at, and options (minimum 2) are required
        - End date must be after start date
        - Binding polls require `polls.binding-enabled` flag to be `true`

        **Workflow:**
        1. Validates input and feature flags
        2. Sanitizes title and description (strips HTML)
        3. Creates poll and poll options in transaction
        4. Logs audit event
        5. Optionally sends email notifications if `notify_members` is true

        **Feature Flags:**
        - `polls.binding-enabled`: Required for binding poll creation
        - `polls.notify-members-enabled`: Gates email notification functionality
      operationId: createPoll
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PollCreateRequest'
            examples:
              informal:
                summary: Informal poll creation
                value:
                  title: "Should we add a new playground?"
                  description: "Community feedback on playground location"
                  type: "informal"
                  is_anonymous: false
                  notify_members: true
                  start_at: "2025-01-15T00:00:00.000Z"
                  end_at: "2025-01-22T23:59:59.000Z"
                  options:
                    - text: "Near the pool"
                      order_index: 0
                    - text: "Near the tennis courts"
                      order_index: 1
                    - text: "No new playground"
                      order_index: 2
              binding:
                summary: Binding poll creation
                value:
                  title: "Annual Budget Approval"
                  description: "Vote to approve the 2025 budget of $150,000"
                  type: "binding"
                  is_anonymous: false
                  notify_members: true
                  start_at: "2025-02-01T00:00:00.000Z"
                  end_at: "2025-02-07T23:59:59.000Z"
                  options:
                    - text: "Approve budget"
                      order_index: 0
                    - text: "Reject budget"
                      order_index: 1
      responses:
        '201':
          description: Poll created successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - message
                  - poll
                properties:
                  message:
                    type: string
                  poll:
                    $ref: '#/components/schemas/PollDetail'
              example:
                message: "Poll created successfully"
                poll:
                  id: 1
                  title: "Should we add a new playground?"
                  description: "Community feedback on playground location"
                  type: "informal"
                  is_anonymous: false
                  notify_members: true
                  start_at: "2025-01-15T00:00:00.000Z"
                  end_at: "2025-01-22T23:59:59.000Z"
                  created_by: 1
                  created_at: "2025-01-10T12:00:00.000Z"
                  options:
                    - id: 1
                      poll_id: 1
                      text: "Near the pool"
                      order_index: 0
                    - id: 2
                      poll_id: 1
                      text: "Near the tennis courts"
                      order_index: 1
        '400':
          description: Bad request - Missing fields or validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingFields:
                  summary: Missing required fields
                  value:
                    message: "Missing required fields: title, type, start_at, end_at, options"
                invalidDates:
                  summary: Invalid date range
                  value:
                    message: "End date must be after start date"
                invalidType:
                  summary: Invalid poll type
                  value:
                    message: "Invalid poll type. Must be one of: informal, binding, straw-poll"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Forbidden - Feature flag disabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Binding polls are currently disabled"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /polls/receipts/{code}:
    get:
      tags:
        - Polls
      summary: Verify a vote receipt
      description: |
        Public endpoint for verifying vote receipts using constant-time comparison.

        **Receipt Format:**
        - 16+ character alphanumeric code
        - Generated using cryptographic hash chain

        **Privacy:**
        - Returns poll and option information
        - Does NOT expose voter identity
        - Constant-time response to prevent timing attacks

        **Response:**
        - Returns receipt details if valid
        - Returns 404 for invalid receipts (constant time)
      operationId: verifyReceipt
      parameters:
        - name: code
          in: path
          required: true
          description: Vote receipt code
          schema:
            type: string
            minLength: 16
      responses:
        '200':
          description: Receipt verified successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - message
                  - receipt
                properties:
                  message:
                    type: string
                  receipt:
                    $ref: '#/components/schemas/VoteReceiptVerification'
              example:
                message: "Receipt verified"
                receipt:
                  hash: "a8b9c0d1e2f3..."
                  poll_id: 1
                  poll_title: "Should we add a new playground?"
                  option_label: "Near the pool"
                  timestamp: "2025-01-16T14:22:00.000Z"
                  verification_status: "valid"
        '400':
          description: Invalid receipt format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Invalid receipt code format"
        '404':
          description: Receipt not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Receipt not found"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /polls/{id}:
    get:
      tags:
        - Polls
      summary: Get poll details by ID
      description: |
        Returns detailed poll information including options and status.

        **Access:**
        - Public and member access
        - Optional authentication for enhanced visibility

        **Query Parameters:**
        - `include_results`: Set to `true` to include vote counts (only for closed polls)

        **Status:**
        - Poll status is calculated server-side based on start_at and end_at
      operationId: getPollById
      security:
        - {}
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Poll ID
          schema:
            type: integer
        - name: include_results
          in: query
          description: Include vote counts (only for closed polls)
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Poll retrieved successfully
          headers:
            RateLimit-Limit:
              schema:
                type: integer
            RateLimit-Remaining:
              schema:
                type: integer
            RateLimit-Reset:
              schema:
                type: integer
          content:
            application/json:
              schema:
                type: object
                required:
                  - poll
                properties:
                  poll:
                    $ref: '#/components/schemas/PollDetail'
              examples:
                active:
                  summary: Active poll without results
                  value:
                    poll:
                      id: 1
                      title: "Should we add a new playground?"
                      description: "Community feedback on playground location"
                      type: "informal"
                      is_anonymous: false
                      start_at: "2025-01-15T00:00:00.000Z"
                      end_at: "2025-01-22T23:59:59.000Z"
                      status: "active"
                      options:
                        - id: 1
                          text: "Near the pool"
                          order_index: 0
                        - id: 2
                          text: "Near the tennis courts"
                          order_index: 1
                      created_by: "Admin User"
                      created_at: "2025-01-10T12:00:00.000Z"
                closedWithResults:
                  summary: Closed poll with results
                  value:
                    poll:
                      id: 1
                      title: "Should we add a new playground?"
                      description: "Community feedback on playground location"
                      type: "informal"
                      is_anonymous: false
                      start_at: "2025-01-15T00:00:00.000Z"
                      end_at: "2025-01-22T23:59:59.000Z"
                      status: "closed"
                      options:
                        - id: 1
                          text: "Near the pool"
                          order_index: 0
                        - id: 2
                          text: "Near the tennis courts"
                          order_index: 1
                      created_by: "Admin User"
                      created_at: "2025-01-10T12:00:00.000Z"
                      results:
                        - option_id: 1
                          text: "Near the pool"
                          vote_count: 45
                        - option_id: 2
                          text: "Near the tennis courts"
                          vote_count: 32
        '404':
          description: Poll not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Poll not found"
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /polls/{id}/votes:
    post:
      tags:
        - Polls
      summary: Cast a vote in a poll
      description: |
        Member-only endpoint to cast a vote with hash chain integrity.

        **Authentication:**
        - Requires valid JWT token with member or admin role

        **Validation:**
        - Poll must be active (between start_at and end_at)
        - Option must belong to the poll
        - User cannot vote twice (for non-anonymous polls)

        **Hash Chain:**
        - Vote is appended to cryptographic hash chain
        - Receipt code is generated for verification
        - Uses formula: `SHA256(user_id + option_id + timestamp + prev_hash)`

        **Transaction Safety:**
        - Uses `BEGIN IMMEDIATE` for serialized access
        - Locks poll record during vote submission
        - All-or-nothing commit ensures data integrity
      operationId: castVote
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Poll ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VoteRequest'
            example:
              option_id: 1
      responses:
        '201':
          description: Vote cast successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoteResponse'
              example:
                message: "Vote cast successfully"
                receipt: "a8b9c0d1e2f3g4h5i6j7k8l9"
                submitted_at: "2025-01-16T14:22:00.000Z"
                integrity:
                  vote_hash: "9f8e7d6c5b4a3..."
                  prev_hash: "1a2b3c4d5e6f..."
        '400':
          description: Bad request - Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingField:
                  summary: Missing option_id
                  value:
                    message: "Missing required field: option_id"
                notStarted:
                  summary: Poll not started
                  value:
                    message: "Poll has not started yet"
                closed:
                  summary: Poll closed
                  value:
                    message: "Poll has already closed"
                invalidOption:
                  summary: Invalid option
                  value:
                    message: "Invalid poll option"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Poll not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Poll not found"
        '409':
          description: Conflict - User already voted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "User has already voted in this poll"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /polls/{id}/results:
    get:
      tags:
        - Polls
      summary: Get poll results
      description: |
        Returns vote counts for each poll option.

        **Access:**
        - Public access for closed polls
        - Admin-only access for active polls

        **Privacy:**
        - Returns aggregated counts only
        - Does not expose individual voter identities
      operationId: getPollResults
      security:
        - {}
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Poll ID
          schema:
            type: integer
      responses:
        '200':
          description: Poll results retrieved successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - poll
                  - results
                properties:
                  poll:
                    type: object
                    required:
                      - id
                      - title
                      - type
                      - status
                    properties:
                      id:
                        type: integer
                      title:
                        type: string
                      type:
                        type: string
                        enum: [informal, binding, straw-poll]
                      status:
                        type: string
                        enum: [scheduled, active, closed]
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/PollResult'
              example:
                poll:
                  id: 1
                  title: "Should we add a new playground?"
                  type: "informal"
                  status: "closed"
                results:
                  - option_id: 1
                    text: "Near the pool"
                    vote_count: 45
                  - option_id: 2
                    text: "Near the tennis courts"
                    vote_count: 32
        '403':
          description: Forbidden - Results not available for active polls
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Poll results are only available after the poll closes"
        '404':
          description: Poll not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Poll not found"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /polls/{id}/integrity:
    get:
      tags:
        - Polls Admin
      summary: Validate poll hash chain integrity
      description: |
        Admin-only endpoint to validate the cryptographic hash chain for a poll.

        **Validation Process:**
        1. Retrieves all votes in chronological order
        2. Recalculates each vote hash
        3. Verifies chain links (each prev_hash matches previous vote_hash)
        4. Returns validation report with any discrepancies

        **Use Cases:**
        - Post-poll audit verification
        - Investigating potential tampering
        - Compliance reporting
      operationId: validatePollIntegrity
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Poll ID
          schema:
            type: integer
      responses:
        '200':
          description: Hash chain validation completed
          content:
            application/json:
              schema:
                type: object
                required:
                  - message
                  - validation
                properties:
                  message:
                    type: string
                  validation:
                    type: object
                    required:
                      - isValid
                      - totalVotes
                      - errors
                    properties:
                      isValid:
                        type: boolean
                      totalVotes:
                        type: integer
                      errors:
                        type: array
                        items:
                          type: object
              example:
                message: "Hash chain validation completed"
                validation:
                  isValid: true
                  totalVotes: 77
                  errors: []
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /vendors:
    get:
      tags:
        - Vendors
      summary: Get vendors with optional filtering
      description: |
        Returns vendors based on user authentication status and role.

        **Guest Users (unauthenticated):**
        - See only vendors in categories listed in `vendors.public-categories` config flag
        - See only approved vendors with public visibility
        - See only name and category (no contact info or ratings)

        **Authenticated Members:**
        - See approved vendors with public or member visibility
        - See name, category, contact info, and ratings

        **Admins:**
        - See all vendors regardless of moderation state or visibility
        - See all fields including moderation state and notes

        Results are sorted by category (ascending), then name (ascending).
      operationId: getVendors
      security:
        - {}
        - BearerAuth: []
      parameters:
        - name: category
          in: query
          description: Filter by service category
          schema:
            type: string
          example: "Landscaping"
        - name: search
          in: query
          description: Search vendors by name (partial match)
          schema:
            type: string
          example: "Green"
        - name: status
          in: query
          description: Filter by moderation state (admin only)
          schema:
            type: string
            enum: [pending, approved, denied]
          example: "pending"
      responses:
        '200':
          description: Vendors retrieved successfully
          headers:
            RateLimit-Limit:
              schema:
                type: integer
            RateLimit-Remaining:
              schema:
                type: integer
            RateLimit-Reset:
              schema:
                type: integer
          content:
            application/json:
              schema:
                type: object
                required:
                  - vendors
                  - count
                properties:
                  vendors:
                    type: array
                    items:
                      $ref: '#/components/schemas/Vendor'
                  count:
                    type: integer
                    description: Number of vendors returned
                  filters:
                    type: object
                    properties:
                      category:
                        type: string
                        nullable: true
                      search:
                        type: string
                        nullable: true
                      status:
                        type: string
                        nullable: true
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Vendors
      summary: Create a new vendor
      description: |
        Submit a new vendor entry.

        **Members:** Vendor submitted for moderation (returns HTTP 202 Accepted)
        **Admins:** Vendor directly approved (returns HTTP 201 Created)

        Rate-limited to prevent abuse.
      operationId: createVendor
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - service_category
              properties:
                name:
                  type: string
                  description: Vendor business name
                  example: "Green Thumb Landscaping"
                service_category:
                  type: string
                  description: Service category
                  example: "Landscaping"
                contact_info:
                  type: string
                  nullable: true
                  description: Contact information (phone, email, address)
                  example: "555-1234, info@greenthumb.com"
                rating:
                  type: integer
                  nullable: true
                  minimum: 1
                  maximum: 5
                  description: Internal rating (1-5 scale)
                  example: 4
                notes:
                  type: string
                  nullable: true
                  description: Internal notes about vendor
                  example: "Reliable service, good pricing"
                visibility_scope:
                  type: string
                  enum: [public, members, admins]
                  description: Visibility level
                  example: "members"
      responses:
        '201':
          description: Vendor created successfully (admin)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Vendor created successfully"
                  vendor:
                    $ref: '#/components/schemas/VendorFull'
        '202':
          description: Vendor submitted for moderation (member)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Vendor submitted for moderation"
                  vendor:
                    $ref: '#/components/schemas/VendorFull'
        '400':
          description: Bad request - validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /vendors/stats:
    get:
      tags:
        - Vendors Admin
      summary: Get vendor statistics
      description: |
        Returns vendor statistics including:
        - Count by moderation state (pending, approved, denied)
        - Count by service category (approved vendors only)

        Admin access required.
      operationId: getVendorStats
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Vendor statistics retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  stats:
                    type: object
                    properties:
                      byModerationState:
                        type: array
                        items:
                          type: object
                          properties:
                            state:
                              type: string
                              enum: [pending, approved, denied]
                            count:
                              type: integer
                      byCategory:
                        type: array
                        items:
                          type: object
                          properties:
                            category:
                              type: string
                            count:
                              type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /vendors/{id}:
    get:
      tags:
        - Vendors
      summary: Get vendor details by ID
      description: |
        Returns vendor details based on user authentication and visibility rules.
        Returns HTTP 404 if vendor not found or not visible to requester.
      operationId: getVendorById
      security:
        - {}
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Vendor ID
          schema:
            type: integer
          example: 1
      responses:
        '200':
          description: Vendor retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  vendor:
                    $ref: '#/components/schemas/Vendor'
        '404':
          description: Vendor not found or not visible
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Vendors Admin
      summary: Update a vendor
      description: |
        Update vendor details. Admin access required.
        All fields are optional - only provided fields will be updated.
      operationId: updateVendor
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Vendor ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                service_category:
                  type: string
                contact_info:
                  type: string
                  nullable: true
                rating:
                  type: integer
                  minimum: 1
                  maximum: 5
                  nullable: true
                notes:
                  type: string
                  nullable: true
                visibility_scope:
                  type: string
                  enum: [public, members, admins]
                moderation_state:
                  type: string
                  enum: [pending, approved, denied]
      responses:
        '200':
          description: Vendor updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Vendor updated successfully"
                  vendor:
                    $ref: '#/components/schemas/VendorFull'
        '400':
          description: Bad request - validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Vendor not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Vendors Admin
      summary: Delete a vendor
      description: Delete a vendor. Admin access required. This action is logged in the audit trail.
      operationId: deleteVendor
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Vendor ID
          schema:
            type: integer
      responses:
        '200':
          description: Vendor deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Vendor deleted successfully"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Vendor not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /vendors/{id}/moderate:
    patch:
      tags:
        - Vendors Admin
      summary: Update vendor moderation state
      description: |
        Update the moderation state of a vendor (pending, approved, denied).
        Admin access required. This action is logged in the audit trail.
      operationId: moderateVendor
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Vendor ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - moderation_state
              properties:
                moderation_state:
                  type: string
                  enum: [pending, approved, denied]
                  description: New moderation state
                  example: "approved"
      responses:
        '200':
          description: Moderation state updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Vendor moderation state updated successfully"
                  vendor:
                    $ref: '#/components/schemas/VendorFull'
        '400':
          description: Bad request - invalid moderation state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Vendor not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token obtained from authentication endpoints.
        Admin role required for administrative operations.

  schemas:
    RosterMember:
      type: object
      required:
        - id
        - user
        - title
        - start_date
        - created_at
      properties:
        id:
          type: integer
          description: Board member record ID
        user:
          type: object
          required:
            - id
            - name
            - email
          properties:
            id:
              type: integer
            name:
              type: string
            email:
              type: string
              format: email
        title:
          type: object
          required:
            - id
            - title
            - rank
          properties:
            id:
              type: integer
            title:
              type: string
            rank:
              type: integer
        start_date:
          type: string
          format: date
          description: Date the member assumed this position
        bio:
          type: string
          nullable: true
          description: Optional biography or description
        created_at:
          type: string
          format: date-time
          description: Timestamp when record was created

    HistoricalMember:
      type: object
      required:
        - id
        - user
        - title
        - start_date
        - end_date
        - created_at
      properties:
        id:
          type: integer
        user:
          type: object
          required:
            - id
            - name
            - email
          properties:
            id:
              type: integer
            name:
              type: string
            email:
              type: string
              format: email
        title:
          type: object
          required:
            - id
            - title
            - rank
          properties:
            id:
              type: integer
            title:
              type: string
            rank:
              type: integer
        start_date:
          type: string
          format: date
        end_date:
          type: string
          format: date
          description: Date the member's term ended
        bio:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time

    ContactRequest:
      type: object
      required:
        - requestor_email
        - subject
        - message
        - captcha_token
        - captchaToken
      properties:
        requestor_email:
          type: string
          format: email
          description: Email address of the person contacting the board
        subject:
          type: string
          description: Subject line (will be sanitized to strip HTML)
        message:
          type: string
          description: Message body (will be sanitized to strip HTML)
        captcha_token:
          type: string
          description: Cloudflare Turnstile CAPTCHA token (stored with request)
        captchaToken:
          type: string
          description: Cloudflare Turnstile CAPTCHA token (for verification middleware)

    ContactResponse:
      type: object
      required:
        - message
        - id
        - status
        - submitted_at
      properties:
        message:
          type: string
          example: "Contact request submitted successfully"
        id:
          type: integer
          description: ContactRequest record ID
        status:
          type: string
          enum: [pending, sent, failed]
          description: Status of the contact request
        submitted_at:
          type: string
          format: date-time
          description: Timestamp when request was submitted

    BoardTitle:
      type: object
      required:
        - id
        - title
        - rank
      properties:
        id:
          type: integer
        title:
          type: string
          description: Title name (e.g., "President", "Vice President")
        rank:
          type: integer
          description: Sort order for display (lower numbers first)
        description:
          type: string
          nullable: true
          description: Optional description of the title

    BoardTitleInput:
      type: object
      required:
        - title
        - rank
      properties:
        title:
          type: string
        rank:
          type: integer

    BoardMember:
      type: object
      required:
        - id
        - user_id
        - title_id
        - start_date
        - created_at
      properties:
        id:
          type: integer
        user_id:
          type: integer
          description: Reference to User record
        title_id:
          type: integer
          description: Reference to BoardTitle record
        start_date:
          type: string
          format: date
        end_date:
          type: string
          format: date
          nullable: true
          description: Null for active positions, set to mark term as ended
        bio:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time

    BoardMemberInput:
      type: object
      required:
        - user_id
        - title_id
        - start_date
      properties:
        user_id:
          type: integer
        title_id:
          type: integer
        start_date:
          type: string
          format: date
        bio:
          type: string
          nullable: true

    Error:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: Human-readable error message

    PollSummary:
      type: object
      required:
        - id
        - title
        - type
        - is_anonymous
        - start_at
        - end_at
        - status
        - options
        - created_by
        - created_at
      properties:
        id:
          type: integer
          description: Poll ID
        title:
          type: string
          description: Poll title
        description:
          type: string
          nullable: true
          description: Optional poll description
        type:
          type: string
          enum: [informal, binding, straw-poll]
          description: Poll type
        is_anonymous:
          type: boolean
          description: Whether votes are anonymous
        start_at:
          type: string
          format: date-time
          description: Poll start timestamp
        end_at:
          type: string
          format: date-time
          description: Poll end timestamp
        status:
          type: string
          enum: [scheduled, active, closed]
          description: Poll status calculated server-side
        options:
          type: array
          items:
            $ref: '#/components/schemas/PollOptionSummary'
          description: Poll options
        created_by:
          type: string
          description: Name of poll creator
        created_at:
          type: string
          format: date-time
          description: Poll creation timestamp

    PollDetail:
      type: object
      required:
        - id
        - title
        - type
        - is_anonymous
        - start_at
        - end_at
        - status
        - options
        - created_by
        - created_at
      properties:
        id:
          type: integer
        title:
          type: string
        description:
          type: string
          nullable: true
        type:
          type: string
          enum: [informal, binding, straw-poll]
        is_anonymous:
          type: boolean
        notify_members:
          type: boolean
          description: Whether members were notified
        start_at:
          type: string
          format: date-time
        end_at:
          type: string
          format: date-time
        status:
          type: string
          enum: [scheduled, active, closed]
        options:
          type: array
          items:
            $ref: '#/components/schemas/PollOptionSummary'
        created_by:
          type: string
        created_at:
          type: string
          format: date-time
        results:
          type: array
          items:
            $ref: '#/components/schemas/PollResult'
          nullable: true
          description: Vote counts (only for closed polls when requested)

    PollOptionSummary:
      type: object
      required:
        - id
        - text
        - order_index
      properties:
        id:
          type: integer
          description: Option ID
        text:
          type: string
          description: Option text
        order_index:
          type: integer
          description: Display order

    PollCreateRequest:
      type: object
      required:
        - title
        - type
        - start_at
        - end_at
        - options
      properties:
        title:
          type: string
          description: Poll title
        description:
          type: string
          nullable: true
          description: Optional poll description
        type:
          type: string
          enum: [informal, binding, straw-poll]
          description: Poll type
        is_anonymous:
          type: boolean
          default: false
          description: Whether votes should be anonymous
        notify_members:
          type: boolean
          default: false
          description: Send email notifications to members
        start_at:
          type: string
          format: date-time
          description: Poll start timestamp
        end_at:
          type: string
          format: date-time
          description: Poll end timestamp
        options:
          type: array
          minItems: 2
          items:
            type: object
            required:
              - text
            properties:
              text:
                type: string
                description: Option text
              order_index:
                type: integer
                description: Optional display order (defaults to array index)

    VoteRequest:
      type: object
      required:
        - option_id
      properties:
        option_id:
          type: integer
          description: ID of the poll option to vote for

    VoteResponse:
      type: object
      required:
        - message
        - receipt
        - submitted_at
        - integrity
      properties:
        message:
          type: string
          example: "Vote cast successfully"
        receipt:
          type: string
          description: Receipt code for vote verification
        submitted_at:
          type: string
          format: date-time
          description: Vote submission timestamp
        integrity:
          type: object
          required:
            - vote_hash
            - prev_hash
          properties:
            vote_hash:
              type: string
              description: Cryptographic hash of this vote
            prev_hash:
              type: string
              description: Hash of previous vote in chain (or "GENESIS" for first vote)

    VoteReceiptVerification:
      type: object
      required:
        - hash
        - poll_id
        - poll_title
        - option_label
        - timestamp
        - verification_status
      properties:
        hash:
          type: string
          description: Vote hash
        poll_id:
          type: integer
          description: Poll ID
        poll_title:
          type: string
          description: Poll title
        option_label:
          type: string
          description: Selected option text
        timestamp:
          type: string
          format: date-time
          description: Vote timestamp
        verification_status:
          type: string
          enum: [valid, invalid]
          description: Verification result

    PollResult:
      type: object
      required:
        - option_id
        - text
        - vote_count
      properties:
        option_id:
          type: integer
          description: Option ID
        text:
          type: string
          description: Option text
        vote_count:
          type: integer
          description: Number of votes for this option

    Vendor:
      type: object
      description: Vendor DTO with fields visible based on user role
      required:
        - id
        - name
        - service_category
        - visibility_scope
      properties:
        id:
          type: integer
          description: Vendor ID
        name:
          type: string
          description: Vendor business name
        service_category:
          type: string
          description: Service category
        visibility_scope:
          type: string
          enum: [public, members, admins]
          description: Visibility level
        contact_info:
          type: string
          nullable: true
          description: Contact information (visible to members and admins only)
        rating:
          type: integer
          nullable: true
          minimum: 1
          maximum: 5
          description: Internal rating (visible to members and admins only)

    VendorFull:
      type: object
      description: Full vendor object with all fields (admin view)
      required:
        - id
        - name
        - service_category
        - visibility_scope
        - moderation_state
        - created_at
        - updated_at
      properties:
        id:
          type: integer
          description: Vendor ID
        name:
          type: string
          description: Vendor business name
        service_category:
          type: string
          description: Service category
        contact_info:
          type: string
          nullable: true
          description: Contact information
        rating:
          type: integer
          nullable: true
          minimum: 1
          maximum: 5
          description: Internal rating (1-5 scale)
        notes:
          type: string
          nullable: true
          description: Internal notes about vendor
        visibility_scope:
          type: string
          enum: [public, members, admins]
          description: Visibility level
        moderation_state:
          type: string
          enum: [pending, approved, denied]
          description: Moderation status
        created_by:
          type: integer
          nullable: true
          description: User ID who created this vendor
        created_at:
          type: string
          format: date-time
          description: Timestamp when vendor was created
        updated_at:
          type: string
          format: date-time
          description: Timestamp when vendor was last updated

  responses:
    Unauthorized:
      description: Unauthorized - Missing or invalid JWT token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: "Unauthorized"

    RateLimitExceeded:
      description: Too Many Requests - Rate limit exceeded
      headers:
        RateLimit-Limit:
          schema:
            type: integer
          description: Maximum requests per window
        RateLimit-Remaining:
          schema:
            type: integer
          description: Remaining requests in current window (will be 0)
        RateLimit-Reset:
          schema:
            type: integer
          description: Time when rate limit resets (Unix timestamp)
        Retry-After:
          schema:
            type: integer
          description: Seconds to wait before retrying
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: "Too many requests from this IP, please try again later."

    InternalServerError:
      description: Internal Server Error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: "Internal server error"
