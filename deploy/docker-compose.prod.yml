services:
  backend:
    image: ${BACKEND_IMAGE}
    container_name: hoa_backend_prod
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=${APP_PORT:-3001}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}
      - DB_PATH=/usr/src/app/backend/database/hoa.db
      - MAX_FILE_SIZE_MB=${MAX_FILE_SIZE_MB:-10}
      - EMAIL_PROVIDER=${EMAIL_PROVIDER}
      - EMAIL_FROM=${EMAIL_FROM}
      - EMAIL_FROM_NAME=${EMAIL_FROM_NAME}
      - EMAIL_REPLY_TO=${EMAIL_REPLY_TO}
      - FRONTEND_BASE_URL=${FRONTEND_BASE_URL}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - TURNSTILE_SECRET_KEY=${TURNSTILE_SECRET_KEY}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
    ports:
      - "127.0.0.1:${APP_PORT:-3001}:${APP_PORT:-3001}"
    volumes:
      - ../backend/database:/usr/src/app/backend/database
      - ../backend/uploads:/usr/src/app/backend/uploads
      - /var/log/hoa-management:/var/log/hoa-management
    networks:
      - hoa-network
    healthcheck:
      test:
        - CMD-SHELL
        - >
          node -e "fetch('http://localhost:${APP_PORT:-3001}/api/health')
            .then(res => { if (res.ok) process.exit(0); process.exit(1); })
            .catch(() => process.exit(1));"
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  frontend:
    image: ${FRONTEND_IMAGE}
    container_name: hoa_frontend_prod
    restart: unless-stopped
    ports:
      - "127.0.0.1:${FRONTEND_PORT:-3000}:80"
    networks:
      - hoa-network
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test:
        - CMD-SHELL
        - wget -q --spider http://127.0.0.1:80/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  hoa-network:
    external: true
    name: hoa-management-network

volumes:
  database_data:
    driver: local
  uploads_data:
    driver: local
